<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>GiftMemory</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script defer data-domain="jddd-eng.github.io/giftmemory" src="https://plausible.io/js/script.tagged-events.js"></script>
<script>window.trackEvent=function(n,p){if(typeof plausible==='function')plausible(n,{props:p||{}});};</script>
<style>
:root{--cream:#FAF6F0;--cream2:#F2EBE0;--gold:#C8922A;--gold-light:#E8B84B;--gold-pale:#FDF3E0;--brown:#3D2B1F;--brown2:#6B4C35;--green:#2D6A4F;--green-pale:#D8F3DC;--red:#9B2226;--red-pale:#FFE5E5;--gray:#9E8E80;--shadow:0 4px 24px rgba(61,43,31,.10);--shadow-sm:0 2px 8px rgba(61,43,31,.08);--radius:18px;--radius-sm:10px;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--brown);min-height:100vh;max-width:480px;margin:0 auto;overflow-x:hidden;}
h1,h2,h3{font-family:'Playfair Display',serif;}
.view{display:none;flex-direction:column;min-height:100vh;animation:fadeIn .22s ease;}
.view.active{display:flex;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.hero{background:linear-gradient(145deg,var(--brown) 0%,var(--brown2) 100%);padding:24px 18px 0;position:relative;overflow:hidden;}
.hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 70% 30%,rgba(200,146,42,.25) 0%,transparent 60%);}
.hero-top{display:flex;align-items:center;justify-content:space-between;position:relative;margin-bottom:14px;}
.hero-title{display:flex;align-items:center;gap:9px;}
.hero-title h1{font-size:1.45rem;color:#FAF6F0;letter-spacing:-.3px;}
.hero-title span{font-size:1.5rem;}
.hero-actions{display:flex;gap:7px;align-items:center;}
.hero-btn{background:rgba(255,255,255,.15);border:none;border-radius:20px;padding:6px 13px;font-size:.74rem;font-weight:600;color:white;cursor:pointer;font-family:'DM Sans',sans-serif;}
.hero-btn.gold{background:linear-gradient(135deg,var(--gold),var(--gold-light));box-shadow:0 3px 10px rgba(200,146,42,.4);}
.home-tabs{display:flex;position:relative;z-index:2;}
.home-tab{flex:1;padding:11px 4px;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;color:rgba(250,246,240,.5);cursor:pointer;border-bottom:2.5px solid transparent;transition:all .2s;}
.home-tab.active{color:var(--gold-light);border-bottom-color:var(--gold-light);}
.stats-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-box{background:white;border-radius:var(--radius-sm);padding:11px 8px;text-align:center;box-shadow:var(--shadow-sm);}
.stat-box .val{font-size:1.2rem;font-weight:700;color:var(--gold);font-family:'Playfair Display',serif;}
.stat-box .lbl{font-size:.67rem;color:var(--gray);margin-top:2px;}
.tab-panel{display:none;}.tab-panel.active{display:block;}
.content-area{padding:16px 16px 100px;}
.search-bar{display:flex;align-items:center;gap:10px;background:white;border:1.5px solid var(--cream2);border-radius:var(--radius-sm);padding:9px 13px;margin-bottom:13px;}
.search-bar input{border:none;background:none;flex:1;font-family:'DM Sans',sans-serif;font-size:.91rem;color:var(--brown);}
.search-bar input:focus{outline:none;}
.person-card{background:white;border-radius:var(--radius);padding:13px 15px;margin-bottom:9px;box-shadow:var(--shadow-sm);display:flex;align-items:center;gap:11px;cursor:pointer;transition:transform .15s,box-shadow .15s;border:1.5px solid transparent;}
.person-card:active{transform:scale(.98);}
.person-card:hover{border-color:var(--gold-light);box-shadow:var(--shadow);}
.person-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--gold-light),var(--gold));display:flex;align-items:center;justify-content:center;font-size:1.15rem;font-weight:700;color:white;flex-shrink:0;font-family:'Playfair Display',serif;}
.person-info{flex:1;min-width:0;}
.person-name{font-weight:600;font-size:.93rem;}
.person-sub{font-size:.73rem;color:var(--gray);margin-top:2px;}
.person-badge{font-size:.68rem;font-weight:600;padding:3px 8px;border-radius:20px;flex-shrink:0;}
.badge-ok{background:var(--green-pale);color:var(--green);}
.badge-low{background:#FFF3CD;color:#856404;}
.card{background:white;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow-sm);margin-bottom:11px;}
.gift-item{display:flex;align-items:center;gap:11px;padding:10px 0;border-bottom:1px solid var(--cream2);}
.gift-item:last-child{border-bottom:none;}
.gift-dir{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.88rem;flex-shrink:0;}
.gift-dir.given{background:var(--green-pale);}
.gift-dir.received{background:var(--red-pale);}
.gift-info{flex:1;}
.gift-occasion{font-weight:600;font-size:.86rem;}
.gift-date{font-size:.71rem;color:var(--gray);}
.gift-note{font-size:.71rem;color:var(--gray);font-style:italic;}
.gift-amount{font-family:'Playfair Display',serif;font-weight:700;font-size:.97rem;}
.gift-amount.given{color:var(--green);}
.gift-amount.received{color:var(--red);}
.grade-pill{display:inline-flex;align-items:center;gap:4px;background:var(--gold-pale);color:var(--gold);border-radius:20px;padding:3px 9px;font-size:.71rem;font-weight:600;}
.rec-box{border-radius:var(--radius);padding:14px 16px;margin-bottom:13px;display:flex;align-items:center;gap:11px;}
.rec-box.ok{background:var(--green-pale);border:1.5px solid #95D5B2;}
.rec-box.low{background:#FFF9E6;border:1.5px solid #FFD166;}
.rec-box.none{background:var(--cream2);border:1.5px solid var(--gold-light);}
.rec-icon{font-size:1.5rem;flex-shrink:0;}
.rec-text h4{font-size:.86rem;font-weight:700;margin-bottom:2px;}
.rec-text p{font-size:.78rem;color:var(--brown2);line-height:1.5;}
.section-title{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--gray);margin-bottom:9px;margin-top:4px;}
.topbar{background:var(--cream);padding:16px 16px 0;position:sticky;top:0;z-index:10;}
.topbar-inner{display:flex;align-items:center;justify-content:space-between;padding-bottom:11px;border-bottom:1.5px solid var(--cream2);}
.topbar h2{font-size:1.15rem;color:var(--brown);}
.back-btn{background:none;border:none;cursor:pointer;font-size:.97rem;color:var(--brown2);padding:4px 8px 4px 0;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:5px;}
.lang-btn{background:var(--gold-pale);border:1px solid var(--gold-light);border-radius:20px;padding:4px 11px;font-size:.71rem;font-weight:600;color:var(--gold);cursor:pointer;font-family:'DM Sans',sans-serif;}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:white;border-top:1.5px solid var(--cream2);display:flex;z-index:15;padding-bottom:env(safe-area-inset-bottom);}
.nav-item{flex:1;padding:10px 0;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;font-size:.62rem;font-weight:600;color:var(--gray);transition:color .15s;border:none;background:none;font-family:'DM Sans',sans-serif;}
.nav-item.active{color:var(--gold);}
.nav-item .nav-icon{font-size:1.2rem;}
.scroll-content{flex:1;overflow-y:auto;}
.fab{position:fixed;bottom:70px;right:18px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-light));color:white;font-size:1.45rem;border:none;box-shadow:0 5px 18px rgba(200,146,42,.45);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s;z-index:20;}
.fab:active{transform:scale(.92);}
.form-group{margin-bottom:13px;}
.form-group label{display:block;font-size:.76rem;font-weight:600;color:var(--brown2);margin-bottom:5px;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid var(--cream2);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.91rem;color:var(--brown);background:white;transition:border-color .2s;-webkit-appearance:none;appearance:none;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--gold);}
.form-group textarea{resize:vertical;min-height:68px;}
.direction-toggle{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.dir-btn{padding:10px;border-radius:var(--radius-sm);border:2px solid var(--cream2);background:white;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.84rem;font-weight:600;color:var(--gray);transition:all .15s;text-align:center;}
.dir-btn.active.given{border-color:var(--green);background:var(--green-pale);color:var(--green);}
.dir-btn.active.received{border-color:var(--red);background:var(--red-pale);color:var(--red);}
.inline-new-person{background:var(--gold-pale);border:1.5px solid var(--gold-light);border-radius:var(--radius-sm);padding:13px;margin-top:7px;display:none;}
.inline-new-person.open{display:block;}
.inline-new-person p{font-size:.76rem;color:var(--brown2);margin-bottom:9px;font-weight:600;}
.btn{width:100%;padding:13px;border:none;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.93rem;font-weight:600;cursor:pointer;transition:all .15s;}
.btn-primary{background:linear-gradient(135deg,var(--gold) 0%,var(--gold-light) 100%);color:white;box-shadow:0 4px 14px rgba(200,146,42,.35);}
.btn-primary:active{transform:scale(.98);}
.btn-secondary{background:var(--cream2);color:var(--brown2);}
.btn-danger{background:var(--red-pale);color:var(--red);margin-top:8px;}
.modal-overlay{position:fixed;inset:0;background:rgba(61,43,31,.5);z-index:50;display:none;align-items:flex-end;backdrop-filter:blur(3px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--cream);width:100%;max-width:480px;margin:0 auto;border-radius:24px 24px 0 0;padding:20px 16px 40px;max-height:92vh;overflow-y:auto;animation:slideUp .28s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--cream2);border-radius:2px;margin:0 auto 16px;}
.modal h3{font-size:1.2rem;margin-bottom:16px;color:var(--brown);}
.grade-row{display:flex;align-items:center;gap:8px;padding:9px 0;border-bottom:1px solid var(--cream2);}
.grade-row:last-child{border-bottom:none;}
.grade-num{width:26px;height:26px;border-radius:50%;background:var(--gold-pale);color:var(--gold);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;flex-shrink:0;}
.grade-row input[type=text]{flex:1;border:1.5px solid var(--cream2);border-radius:8px;padding:6px 9px;font-family:'DM Sans',sans-serif;font-size:.83rem;color:var(--brown);}
.grade-row input[type=number]{width:65px;border:1.5px solid var(--cream2);border-radius:8px;padding:6px 7px;font-family:'DM Sans',sans-serif;font-size:.83rem;color:var(--gold);font-weight:700;text-align:center;}
.grade-row input:focus{outline:none;border-color:var(--gold);}
.empty-state{text-align:center;padding:44px 18px;color:var(--gray);}
.empty-state .emoji{font-size:2.6rem;margin-bottom:9px;}
.empty-state p{font-size:.85rem;line-height:1.6;white-space:pre-line;}
.toast{position:fixed;bottom:84px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--brown);color:white;padding:10px 20px;border-radius:30px;font-size:.84rem;font-weight:500;opacity:0;transition:all .3s;z-index:100;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.occ-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:11px;padding-bottom:9px;border-bottom:1.5px solid var(--cream2);}
.occ-avg{background:var(--gold-pale);color:var(--gold);border-radius:10px;padding:5px 11px;font-family:'Playfair Display',serif;font-weight:700;font-size:.97rem;}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- VIEW: HOME -->
<div class="view active" id="view-home">
  <div class="hero">
    <div class="hero-top">
      <div class="hero-title"><span>üéÅ</span><h1>GiftMemory</h1></div>
      <div class="hero-actions">
        <button class="hero-btn" onclick="toggleLang()" id="lang-btn-home">EN</button>
        <button class="hero-btn gold" onclick="openFabAction()">Ôºã</button>
      </div>
    </div>
    <div class="home-tabs">
      <button class="home-tab active" id="tab-btn-persons" onclick="switchTab('persons')">üë• <span id="tab-lbl-persons">Personen</span></button>
      <button class="home-tab" id="tab-btn-gifts" onclick="switchTab('gifts')">üéÅ <span id="tab-lbl-gifts">Geschenke</span></button>
      <button class="home-tab" id="tab-btn-occasions" onclick="switchTab('occasions')">üîç <span id="tab-lbl-occasions">Anl√§sse</span></button>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area">
      <div class="stats-bar" id="stats-bar"></div>
      <div class="tab-panel active" id="panel-persons">
        <div class="search-bar"><span>üîç</span><input type="text" id="search-input" placeholder="Suchen..." oninput="renderPersonList()"></div>
        <div id="person-list"></div>
      </div>
      <div class="tab-panel" id="panel-gifts"><div id="all-gifts-list"></div></div>
      <div class="tab-panel" id="panel-occasions">
        <p id="lbl-occasions-sub" style="font-size:.79rem;color:var(--gray);margin-bottom:11px;line-height:1.5">Suche nach Anlass-Typ ‚Äì egal wer die Person war</p>
        <div class="search-bar"><span>üîç</span><input type="text" id="occasion-search" placeholder="z.B. Beerdigung..." oninput="renderOccasions()"></div>
        <select id="occasion-grade-filter" onchange="renderOccasions()" style="width:100%;padding:9px 12px;border:1.5px solid var(--cream2);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.86rem;color:var(--brown);background:white;-webkit-appearance:none;margin-bottom:13px"><option value="">‚Äî Alle Grade / All Grades ‚Äî</option></select>
        <div id="occasions-list"></div>
      </div>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="showView('home')"><span class="nav-icon">üè†</span><span id="nav-home">Home</span></button>
    <button class="nav-item" onclick="showView('settings')"><span class="nav-icon">‚öôÔ∏è</span><span id="nav-settings">Einstellungen</span></button>
  </nav>
</div>

<!-- VIEW: PERSON DETAIL -->
<div class="view" id="view-person">
  <div class="topbar">
    <div class="topbar-inner">
      <button class="back-btn" onclick="showView('home')">‚Üê <span id="lbl-back">Zur√ºck</span></button>
      <div style="display:flex;gap:7px">
        <button class="lang-btn" onclick="editPerson()">‚úèÔ∏è</button>
        <button class="lang-btn" onclick="toggleLang()" id="lang-btn2">EN</button>
      </div>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area" style="padding-bottom:100px">
      <div id="person-detail-header" style="text-align:center;padding:14px 0 20px"></div>
      <div id="rec-box-container"></div>
      <div class="section-title" id="lbl-history">Verlauf</div>
      <div id="gift-list-detail"></div>
    </div>
  </div>
  <button class="fab" onclick="openGiftFromPerson()">Ôºã</button>
</div>

<!-- VIEW: SETTINGS -->
<div class="view" id="view-settings">
  <div class="topbar">
    <div class="topbar-inner">
      <h2 id="lbl-settings-title">Einstellungen</h2>
      <button class="lang-btn" onclick="toggleLang()" id="lang-btn4">EN</button>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area" style="padding-bottom:80px">
      <div class="section-title" id="lbl-grades-title">Beziehungsgrade</div>
      <div class="card">
        <div id="grade-settings-list"></div>
        <button class="btn btn-secondary" style="margin-top:11px" onclick="addGrade()" id="btn-add-grade">+ Grad hinzuf√ºgen</button>
      </div>
      <div class="section-title" style="margin-top:16px" id="lbl-lang-title">Sprache / Language</div>
      <div class="card" style="display:flex;gap:10px">
        <button class="btn" onclick="setLang('de')" id="btn-de" style="flex:1">üá©üá™ Deutsch</button>
        <button class="btn" onclick="setLang('en')" id="btn-en" style="flex:1">üá¨üáß English</button>
      </div>
      <div class="section-title" style="margin-top:16px" id="lbl-feedback-title">Feedback</div>
      <div class="card">
        <p id="lbl-feedback-sub" style="font-size:.81rem;color:var(--gray);margin-bottom:11px;line-height:1.6">Ideen, W√ºnsche oder Fehler? Schreib mir direkt.</p>
        <div class="form-group"><label id="lbl-feedback-msg">Deine Nachricht</label><textarea id="feedback-text" rows="3" placeholder="z.B. Ich vermisse..."></textarea></div>
        <div class="form-group"><label id="lbl-feedback-email">E-Mail (optional)</label><input type="email" id="feedback-email" placeholder="name@beispiel.com"></div>
        <button class="btn btn-primary" onclick="sendFeedback()" id="btn-send-feedback">üí¨ Feedback senden</button>
        <div id="feedback-status" style="margin-top:9px;font-size:.81rem;display:none"></div>
      </div>
      <div class="section-title" style="margin-top:16px" id="lbl-data-title">Daten</div>
      <div class="card">
        <button class="btn btn-secondary" onclick="exportData()" id="btn-export">üì§ Daten exportieren</button>
        <button class="btn btn-danger" onclick="confirmReset()" id="btn-reset">üóëÔ∏è Alle Daten l√∂schen</button>
      </div>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-item" onclick="showView('home')"><span class="nav-icon">üè†</span><span id="nav-home2">Home</span></button>
    <button class="nav-item active" onclick="showView('settings')"><span class="nav-icon">‚öôÔ∏è</span><span id="nav-settings2">Einstellungen</span></button>
  </nav>
</div>

<!-- MODAL: ADD/EDIT PERSON -->
<div class="modal-overlay" id="modal-add-person" onclick="closeModalOnOverlay(event,'modal-add-person')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="modal-person-title">Person hinzuf√ºgen</h3>
    <input type="hidden" id="edit-person-id">
    <div class="form-group"><label id="lbl-name">Name</label><input type="text" id="input-name" placeholder="z.B. Mama, Klaus..."></div>
    <div class="form-group"><label id="lbl-grade">Beziehungsgrad</label><select id="input-grade"></select></div>
    <div class="form-group"><label id="lbl-birthday">Geburtstag (optional)</label><input type="date" id="input-birthday"></div>
    <div class="form-group"><label id="lbl-note">Notiz (optional)</label><textarea id="input-note" rows="2"></textarea></div>
    <button class="btn btn-primary" onclick="savePerson()" id="btn-save-person">Speichern</button>
    <button class="btn btn-secondary" style="margin-top:7px" onclick="closeModal('modal-add-person')" id="btn-cancel">Abbrechen</button>
  </div>
</div>

<!-- MODAL: ADD GIFT (with person selector from home) -->
<div class="modal-overlay" id="modal-add-gift" onclick="closeModalOnOverlay(event,'modal-add-gift')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="modal-gift-title">Geschenk eintragen</h3>
    <div class="form-group" id="gift-person-group">
      <label id="lbl-gift-person">Person</label>
      <select id="input-gift-person" onchange="handleGiftPersonSelect(this.value)"></select>
    </div>
    <div class="inline-new-person" id="inline-new-person">
      <p>‚úèÔ∏è <span id="lbl-new-person-hint">Neue Person anlegen:</span></p>
      <div class="form-group"><label id="lbl-new-name">Name</label><input type="text" id="new-person-name" placeholder="z.B. Oma, Peter..."></div>
      <div class="form-group"><label id="lbl-grade2">Beziehungsgrad</label><select id="new-person-grade"></select></div>
    </div>
    <div class="form-group"><label id="lbl-direction">Richtung</label>
      <div class="direction-toggle">
        <button class="dir-btn given active" id="dir-given" onclick="setDirection('given')">‚Üë Gegeben</button>
        <button class="dir-btn received" id="dir-received" onclick="setDirection('received')">‚Üì Bekommen</button>
      </div>
    </div>
    <div class="form-group"><label id="lbl-amount">Betrag (‚Ç¨)</label><input type="number" id="input-amount" placeholder="0" min="0" step="1"></div>
    <div class="form-group"><label id="lbl-occasion">Anlass</label>
      <select id="input-occasion-select" onchange="handleOccasionSelect('input-occasion-select','input-occasion',this.value)" style="margin-bottom:5px">
        <option value="">‚Äî Anlass w√§hlen / Choose occasion ‚Äî</option>
        <optgroup label="H√§ufige Anl√§sse">
          <option value="Geburtstag">üéÇ Geburtstag / Birthday</option>
          <option value="Hochzeit">üíç Hochzeit / Wedding</option>
          <option value="Geburt">üë∂ Geburt / Birth</option>
          <option value="Taufe">‚õ™ Taufe / Baptism</option>
          <option value="Beerdigung / Kondolenz">üïØÔ∏è Beerdigung / Funeral</option>
          <option value="Kommunion / Konfirmation">üôè Kommunion / Konfirmation</option>
          <option value="Weihnachten">üéÑ Weihnachten / Christmas</option>
          <option value="Ostern">üê£ Ostern / Easter</option>
          <option value="Muttertag">üíê Muttertag / Mother's Day</option>
          <option value="Vatertag">üëî Vatertag / Father's Day</option>
          <option value="Valentinstag">‚ù§Ô∏è Valentinstag / Valentine's Day</option>
          <option value="Jubil√§um">ü•Ç Jubil√§um / Anniversary</option>
          <option value="Abschluss / Diplom">üéì Abschluss / Graduation</option>
          <option value="Einzug / Umzug">üè† Einzug / Moving in</option>
          <option value="Pensionierung">üåÖ Pensionierung / Retirement</option>
          <option value="Krankheit / Genesung">üå∑ Krankheit / Get well</option>
          <option value="Sonstiges">‚úèÔ∏è Sonstiges / Other...</option>
        </optgroup>
      </select>
      <input type="text" id="input-occasion" placeholder="Anlass eingeben..." style="display:none">
    </div>
    <div class="form-group"><label id="lbl-date">Datum</label><input type="date" id="input-gift-date"></div>
    <div class="form-group"><label id="lbl-type">Art</label>
      <select id="input-type">
        <option value="money">Geldgeschenk / Money gift</option>
        <option value="physical">Sachgeschenk / Physical gift</option>
        <option value="both">Beides / Both</option>
      </select>
    </div>
    <div class="form-group"><label id="lbl-gift-note">Notiz (optional)</label><textarea id="input-gift-note" rows="2"></textarea></div>
    <button class="btn btn-primary" onclick="saveGift()" id="btn-save-gift">Speichern</button>
    <button class="btn btn-secondary" style="margin-top:7px" onclick="closeModal('modal-add-gift')" id="btn-cancel2">Abbrechen</button>
  </div>
</div>

<!-- MODAL: ADD GIFT from person detail (no person selector) -->
<div class="modal-overlay" id="modal-add-gift-p" onclick="closeModalOnOverlay(event,'modal-add-gift-p')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="modal-gift-p-title">Geschenk eintragen</h3>
    <div class="form-group"><label id="lbl-direction2">Richtung</label>
      <div class="direction-toggle">
        <button class="dir-btn given active" id="dir-given2" onclick="setDirection2('given')">‚Üë Gegeben</button>
        <button class="dir-btn received" id="dir-received2" onclick="setDirection2('received')">‚Üì Bekommen</button>
      </div>
    </div>
    <div class="form-group"><label id="lbl-amount2">Betrag (‚Ç¨)</label><input type="number" id="input-amount2" placeholder="0" min="0" step="1"></div>
    <div class="form-group"><label id="lbl-occasion2">Anlass</label>
      <select id="input-occasion-select2" onchange="handleOccasionSelect('input-occasion-select2','input-occasion2',this.value)" style="margin-bottom:5px">
        <option value="">‚Äî Anlass w√§hlen / Choose occasion ‚Äî</option>
        <optgroup label="H√§ufige Anl√§sse">
          <option value="Geburtstag">üéÇ Geburtstag / Birthday</option>
          <option value="Hochzeit">üíç Hochzeit / Wedding</option>
          <option value="Geburt">üë∂ Geburt / Birth</option>
          <option value="Taufe">‚õ™ Taufe / Baptism</option>
          <option value="Beerdigung / Kondolenz">üïØÔ∏è Beerdigung / Funeral</option>
          <option value="Kommunion / Konfirmation">üôè Kommunion / Konfirmation</option>
          <option value="Weihnachten">üéÑ Weihnachten / Christmas</option>
          <option value="Ostern">üê£ Ostern / Easter</option>
          <option value="Muttertag">üíê Muttertag / Mother's Day</option>
          <option value="Vatertag">üëî Vatertag / Father's Day</option>
          <option value="Valentinstag">‚ù§Ô∏è Valentinstag / Valentine's Day</option>
          <option value="Jubil√§um">ü•Ç Jubil√§um / Anniversary</option>
          <option value="Abschluss / Diplom">üéì Abschluss / Graduation</option>
          <option value="Einzug / Umzug">üè† Einzug / Moving in</option>
          <option value="Pensionierung">üåÖ Pensionierung / Retirement</option>
          <option value="Krankheit / Genesung">üå∑ Krankheit / Get well</option>
          <option value="Sonstiges">‚úèÔ∏è Sonstiges / Other...</option>
        </optgroup>
      </select>
      <input type="text" id="input-occasion2" placeholder="Anlass eingeben..." style="display:none">
    </div>
    <div class="form-group"><label id="lbl-date2">Datum</label><input type="date" id="input-gift-date2"></div>
    <div class="form-group"><label id="lbl-type2">Art</label>
      <select id="input-type2">
        <option value="money">Geldgeschenk / Money gift</option>
        <option value="physical">Sachgeschenk / Physical gift</option>
        <option value="both">Beides / Both</option>
      </select>
    </div>
    <div class="form-group"><label id="lbl-gift-note2">Notiz (optional)</label><textarea id="input-gift-note2" rows="2"></textarea></div>
    <button class="btn btn-primary" onclick="saveGiftFromPerson()" id="btn-save-gift2">Speichern</button>
    <button class="btn btn-secondary" style="margin-top:7px" onclick="closeModal('modal-add-gift-p')" id="btn-cancel3">Abbrechen</button>
  </div>
</div>

<script>
let state={lang:'de',activeTab:'persons',grades:[{id:'g1',name:'Engste Familie / Closest Family',value:200},{id:'g2',name:'Nahe Verwandte / Close Relatives',value:100},{id:'g3',name:'Entfernte Verwandte / Distant Relatives',value:50},{id:'g4',name:'Enge Freunde / Close Friends',value:60},{id:'g5',name:'Bekannte / Acquaintances',value:25}],persons:[],gifts:[]};
let currentPersonId=null,giftDir='given',giftDir2='given';
function save(){try{localStorage.setItem('gm_v1',JSON.stringify(state));}catch(e){}}
function load(){try{const r=localStorage.getItem('gm_v1');if(r)state={...state,...JSON.parse(r)};}catch(e){}}
function uid(){return 'id_'+Math.random().toString(36).substr(2,9);}

const T={
  de:{people:'Personen',gifts:'Geschenke',occasions:'Anl√§sse',settings:'Einstellungen',home:'Home',back:'Zur√ºck',history:'Verlauf',occasionsSub:'Suche nach Anlass-Typ ‚Äì egal wer die Person war',allGrades:'‚Äî Alle Grade ‚Äî',noOccasions:'Keine Eintr√§ge gefunden.',addPerson:'Person hinzuf√ºgen',editPerson:'Person bearbeiten',name:'Name',grade:'Beziehungsgrad',birthday:'Geburtstag (optional)',note:'Notiz (optional)',save:'Speichern',cancel:'Abbrechen',addGift:'Geschenk eintragen',direction:'Richtung',given:'‚Üë Gegeben',received:'‚Üì Bekommen',amount:'Betrag (‚Ç¨)',occasion:'Anlass',date:'Datum',type:'Art',giftNote:'Notiz (optional)',giftPerson:'Person',selectPerson:'‚Äî Person w√§hlen ‚Äî',newPerson:'Ôºã Neue Person anlegen',gradesTitle:'Beziehungsgrade',langTitle:'Sprache',dataTitle:'Daten',addGradeBtn:'+ Grad hinzuf√ºgen',exportBtn:'üì§ Daten exportieren',resetBtn:'üóëÔ∏è Alle Daten l√∂schen',feedbackTitle:'Feedback',feedbackSub:'Ideen, W√ºnsche oder Fehler? Schreib mir direkt.',feedbackMsg:'Deine Nachricht',feedbackEmail:'E-Mail (optional)',feedbackSend:'üí¨ Feedback senden',feedbackOk:'‚úÖ Danke! Nachricht angekommen.',feedbackErr:'‚ùå Fehler beim Senden.',feedbackEmpty:'‚ö†Ô∏è Bitte schreib eine Nachricht.',statPeople:'Personen',statGiven:'Gegeben',statReceived:'Bekommen',recOk:'‚úÖ Passt gut!',recLow:'‚ö†Ô∏è Etwas wenig',recNone:'üí° Noch kein Geschenk',recOkText:r=>`Richtwert: ${r}‚Ç¨ ‚Äì passt.`,recLowText:(l,r)=>`Letztes: ${l}‚Ç¨ ¬∑ Richtwert: ${r}‚Ç¨`,recNoneText:r=>`Richtwert: ${r}‚Ç¨`,noPersons:'Noch keine Personen.\nTippe auf Ôºã um jemanden hinzuzuf√ºgen.',noGifts:'Noch keine Eintr√§ge.\nTippe auf Ôºã um ein Geschenk einzutragen.',noAllGifts:'Noch keine Geschenke.',toast_saved:'Gespeichert ‚úì',toast_deleted:'Gel√∂scht ‚úì',confirmReset:'Wirklich alle Daten l√∂schen?',givenShort:'Gegeben',receivedShort:'Bekommen',avgLabel:'√ò',totalLabel:'Gesamt',selectPersonFirst:'‚ö†Ô∏è Bitte Person ausw√§hlen.',newPersonHint:'Neue Person anlegen:'},
  en:{people:'People',gifts:'Gifts',occasions:'Occasions',settings:'Settings',home:'Home',back:'Back',history:'History',occasionsSub:'Search by occasion type ‚Äì regardless of who the person was',allGrades:'‚Äî All Grades ‚Äî',noOccasions:'No entries found.',addPerson:'Add Person',editPerson:'Edit Person',name:'Name',grade:'Relationship Grade',birthday:'Birthday (optional)',note:'Note (optional)',save:'Save',cancel:'Cancel',addGift:'Add Gift',direction:'Direction',given:'‚Üë Given',received:'‚Üì Received',amount:'Amount (‚Ç¨)',occasion:'Occasion',date:'Date',type:'Type',giftNote:'Note (optional)',giftPerson:'Person',selectPerson:'‚Äî Choose person ‚Äî',newPerson:'Ôºã Add new person',gradesTitle:'Relationship Grades',langTitle:'Language',dataTitle:'Data',addGradeBtn:'+ Add Grade',exportBtn:'üì§ Export Data',resetBtn:'üóëÔ∏è Delete All Data',feedbackTitle:'Feedback',feedbackSub:'Ideas, wishes or bugs? Write me directly.',feedbackMsg:'Your message',feedbackEmail:'Email (optional)',feedbackSend:'üí¨ Send feedback',feedbackOk:'‚úÖ Thank you! Message received.',feedbackErr:'‚ùå Error sending.',feedbackEmpty:'‚ö†Ô∏è Please write a message.',statPeople:'People',statGiven:'Given',statReceived:'Received',recOk:'‚úÖ Looks good!',recLow:'‚ö†Ô∏è A bit low',recNone:'üí° No gift yet',recOkText:r=>`Benchmark: ‚Ç¨${r} ‚Äì you're in range.`,recLowText:(l,r)=>`Last: ‚Ç¨${l} ¬∑ Benchmark: ‚Ç¨${r}`,recNoneText:r=>`Benchmark: ‚Ç¨${r}`,noPersons:'No people yet.\nTap Ôºã to add someone.',noGifts:'No entries yet.\nTap Ôºã to add a gift.',noAllGifts:'No gifts recorded yet.',toast_saved:'Saved ‚úì',toast_deleted:'Deleted ‚úì',confirmReset:'Really delete all data?',givenShort:'Given',receivedShort:'Received',avgLabel:'Avg',totalLabel:'Total',selectPersonFirst:'‚ö†Ô∏è Please select a person.',newPersonHint:'Add new person:'}
};
const t=()=>T[state.lang];
function setEl(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}

function applyLang(){
  const l=t();
  setEl('tab-lbl-persons',l.people);setEl('tab-lbl-gifts',l.gifts);setEl('tab-lbl-occasions',l.occasions);
  setEl('nav-home',l.home);setEl('nav-home2',l.home);setEl('nav-settings',l.settings);setEl('nav-settings2',l.settings);
  setEl('lbl-back',l.back);setEl('lbl-history',l.history);setEl('lbl-occasions-sub',l.occasionsSub);
  setEl('lbl-settings-title',l.settings);setEl('lbl-grades-title',l.gradesTitle);setEl('lbl-lang-title',l.langTitle);setEl('lbl-data-title',l.dataTitle);
  setEl('btn-add-grade',l.addGradeBtn);setEl('btn-export',l.exportBtn);setEl('btn-reset',l.resetBtn);
  setEl('lbl-feedback-title',l.feedbackTitle);setEl('lbl-feedback-sub',l.feedbackSub);setEl('lbl-feedback-msg',l.feedbackMsg);setEl('lbl-feedback-email',l.feedbackEmail);setEl('btn-send-feedback',l.feedbackSend);
  setEl('modal-person-title',document.getElementById('edit-person-id')?.value?l.editPerson:l.addPerson);
  setEl('lbl-name',l.name);setEl('lbl-grade',l.grade);setEl('lbl-grade2',l.grade);setEl('lbl-birthday',l.birthday);setEl('lbl-note',l.note);
  setEl('btn-save-person',l.save);setEl('btn-cancel',l.cancel);setEl('btn-cancel2',l.cancel);setEl('btn-cancel3',l.cancel);
  setEl('modal-gift-title',l.addGift);setEl('modal-gift-p-title',l.addGift);
  setEl('lbl-gift-person',l.giftPerson);setEl('lbl-new-person-hint',l.newPersonHint);
  setEl('lbl-direction',l.direction);setEl('lbl-direction2',l.direction);
  setEl('dir-given',l.given);setEl('dir-received',l.received);setEl('dir-given2',l.given);setEl('dir-received2',l.received);
  setEl('lbl-amount',l.amount);setEl('lbl-amount2',l.amount);setEl('lbl-occasion',l.occasion);setEl('lbl-occasion2',l.occasion);
  setEl('lbl-date',l.date);setEl('lbl-date2',l.date);setEl('lbl-type',l.type);setEl('lbl-type2',l.type);
  setEl('lbl-gift-note',l.giftNote);setEl('lbl-gift-note2',l.giftNote);setEl('btn-save-gift',l.save);setEl('btn-save-gift2',l.save);
  setEl('lbl-new-name',l.name);
  ['lang-btn-home','lang-btn2','lang-btn4'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=state.lang==='de'?'EN':'DE';});
  const bd=document.getElementById('btn-de'),be=document.getElementById('btn-en');
  if(bd)bd.style.fontWeight=state.lang==='de'?'700':'400';
  if(be)be.style.fontWeight=state.lang==='en'?'700':'400';
}
function setLang(l){state.lang=l;save();applyLang();renderAll();}
function toggleLang(){setLang(state.lang==='de'?'en':'de');}

function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  if(name==='home'){renderStats();renderCurrentTab();}
  if(name==='settings')renderGradeSettings();
  trackEvent('View',{v:name});
}

function switchTab(tab){
  state.activeTab=tab;
  document.querySelectorAll('.home-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-btn-'+tab).classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  renderCurrentTab();
  trackEvent('Tab',{t:tab});
}
function renderCurrentTab(){
  if(state.activeTab==='persons')renderPersonList();
  if(state.activeTab==='gifts')renderAllGifts();
  if(state.activeTab==='occasions')renderOccasions();
}

function openFabAction(){
  if(state.activeTab==='persons'){
    document.getElementById('edit-person-id').value='';
    document.getElementById('input-name').value='';
    document.getElementById('input-birthday').value='';
    document.getElementById('input-note').value='';
    populateGradeSelect('input-grade',state.grades[0]?.id);
    setEl('modal-person-title',t().addPerson);
    openModal('modal-add-person');
  } else {
    openGiftFromHome();
  }
}

function renderStats(){
  const l=t();
  const tg=state.gifts.filter(g=>g.direction==='given').reduce((s,g)=>s+g.amount,0);
  const tr=state.gifts.filter(g=>g.direction==='received').reduce((s,g)=>s+g.amount,0);
  document.getElementById('stats-bar').innerHTML=`<div class="stat-box"><div class="val">${state.persons.length}</div><div class="lbl">${l.statPeople}</div></div><div class="stat-box"><div class="val">${tg}‚Ç¨</div><div class="lbl">${l.statGiven}</div></div><div class="stat-box"><div class="val">${tr}‚Ç¨</div><div class="lbl">${l.statReceived}</div></div>`;
}

function renderPersonList(){
  const l=t();
  const search=(document.getElementById('search-input')?.value||'').toLowerCase();
  const filtered=state.persons.filter(p=>p.name.toLowerCase().includes(search));
  const list=document.getElementById('person-list');
  if(!filtered.length){list.innerHTML=`<div class="empty-state"><div class="emoji">üë§</div><p>${l.noPersons}</p></div>`;return;}
  list.innerHTML=filtered.map(p=>{
    const grade=state.grades.find(g=>g.id===p.gradeId);
    const pg=state.gifts.filter(g=>g.personId===p.id&&g.direction==='given');
    const last=pg.length?pg.sort((a,b)=>new Date(b.date)-new Date(a.date))[0].amount:null;
    let badge='',bc='';
    if(last!==null&&grade){if(last>=grade.value*.8){badge='‚úÖ';bc='badge-ok';}else{badge='‚ö†Ô∏è';bc='badge-low';}}
    const gl=grade?grade.name.split('/')[state.lang==='de'?0:1]?.trim()||grade.name:'';
    return `<div class="person-card" onclick="openPersonDetail('${p.id}')"><div class="person-avatar">${p.name.charAt(0).toUpperCase()}</div><div class="person-info"><div class="person-name">${p.name}</div><div class="person-sub">${gl}${grade?' ¬∑ '+grade.value+'‚Ç¨':''}</div></div>${badge?`<span class="person-badge ${bc}">${badge}</span>`:''}</div>`;
  }).join('');
}

function renderAllGifts(){
  const l=t();
  const sorted=[...state.gifts].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const el=document.getElementById('all-gifts-list');
  if(!sorted.length){el.innerHTML=`<div class="empty-state"><div class="emoji">üéÅ</div><p>${l.noAllGifts}</p></div>`;return;}
  el.innerHTML=`<div class="card">${sorted.map(g=>{const p=state.persons.find(x=>x.id===g.personId);const ig=g.direction==='given';return `<div class="gift-item" onclick="openPersonDetail('${g.personId}')" style="cursor:pointer"><div class="gift-dir ${g.direction}">${ig?'‚Üë':'‚Üì'}</div><div class="gift-info"><div class="gift-occasion">${g.occasion}</div><div class="gift-date">${p?p.name:'?'} ¬∑ ${formatDate(g.date)}</div>${g.note?`<div class="gift-note">${g.note}</div>`:''}</div><div class="gift-amount ${g.direction}">${ig?'+':'-'}${g.amount}‚Ç¨</div></div>`;}).join('')}</div>`;
}

function renderOccasions(){
  const l=t();
  const search=(document.getElementById('occasion-search')?.value||'').toLowerCase().trim();
  const gf=document.getElementById('occasion-grade-filter')?.value||'';
  const sel=document.getElementById('occasion-grade-filter');
  if(sel){const cv=sel.value;sel.innerHTML=`<option value="">${l.allGrades}</option>`+state.grades.map(g=>{const gl=g.name.split('/')[state.lang==='de'?0:1]?.trim()||g.name;return`<option value="${g.id}"${g.id===cv?' selected':''}>${gl} (${g.value}‚Ç¨)</option>`;}).join('');}
  let f=state.gifts.filter(g=>g.direction==='given');
  if(search)f=f.filter(g=>g.occasion.toLowerCase().includes(search));
  if(gf){const pids=state.persons.filter(p=>p.gradeId===gf).map(p=>p.id);f=f.filter(g=>pids.includes(g.personId));}
  const el=document.getElementById('occasions-list');
  if(!f.length){el.innerHTML=`<div class="empty-state"><div class="emoji">üîç</div><p>${l.noOccasions}</p></div>`;return;}
  const groups={};f.forEach(g=>{const k=g.occasion.trim().toLowerCase();if(!groups[k])groups[k]={label:g.occasion.trim(),items:[]};groups[k].items.push(g);});
  el.innerHTML=Object.values(groups).sort((a,b)=>b.items.length-a.items.length).map(gr=>{
    const total=gr.items.reduce((s,g)=>s+g.amount,0),avg=Math.round(total/gr.items.length);
    const rows=gr.items.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(g=>{const person=state.persons.find(p=>p.id===g.personId);const grade=person?state.grades.find(x=>x.id===person.gradeId):null;const gl=grade?grade.name.split('/')[state.lang==='de'?0:1]?.trim()||grade.name:'‚Äì';return`<div class="gift-item"><div class="gift-dir given" style="font-size:.76rem;width:29px;height:29px">‚Üë</div><div class="gift-info"><div class="gift-occasion" style="font-size:.84rem">${person?person.name:'?'}</div><div class="gift-date">${gl} ¬∑ ${formatDate(g.date)}</div>${g.note?`<div class="gift-note">${g.note}</div>`:''}</div><div class="gift-amount given" style="font-size:.9rem">${g.amount}‚Ç¨</div></div>`;}).join('');
    return`<div class="card"><div class="occ-header"><div><div style="font-family:'Playfair Display',serif;font-size:1.02rem;font-weight:700">${gr.label}</div><div style="font-size:.7rem;color:var(--gray);margin-top:2px">${gr.items.length}√ó ¬∑ ${l.avgLabel} ${avg}‚Ç¨ ¬∑ ${l.totalLabel} ${total}‚Ç¨</div></div><div class="occ-avg">${avg}‚Ç¨</div></div>${rows}</div>`;
  }).join('');
}

function openPersonDetail(personId){
  currentPersonId=personId;
  const p=state.persons.find(x=>x.id===personId);if(!p)return;
  const grade=state.grades.find(g=>g.id===p.gradeId);const l=t();
  const gl=grade?grade.name.split('/')[state.lang==='de'?0:1]?.trim()||grade.name:'';
  document.getElementById('person-detail-header').innerHTML=`<div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#E8B84B,#C8922A);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-family:'Playfair Display',serif;color:white;font-weight:700;margin:0 auto 9px">${p.name.charAt(0).toUpperCase()}</div><h2 style="font-size:1.45rem;color:var(--brown)">${p.name}</h2><div style="margin-top:7px;display:flex;align-items:center;justify-content:center;gap:6px"><span class="grade-pill">‚≠ê ${gl}</span>${grade?`<span class="grade-pill">${grade.value}‚Ç¨</span>`:''}</div>${p.note?`<p style="margin-top:8px;font-size:.78rem;color:var(--gray);font-style:italic">${p.note}</p>`:''}`;
  const pg=state.gifts.filter(g=>g.personId===personId);
  const given=pg.filter(g=>g.direction==='given').sort((a,b)=>new Date(b.date)-new Date(a.date));
  const lastGiven=given.length?given[0].amount:null;
  let rec='';
  if(grade){if(lastGiven===null)rec=`<div class="rec-box none"><div class="rec-icon">üí°</div><div class="rec-text"><h4>${l.recNone}</h4><p>${l.recNoneText(grade.value)}</p></div></div>`;else if(lastGiven>=grade.value*.8)rec=`<div class="rec-box ok"><div class="rec-icon">‚úÖ</div><div class="rec-text"><h4>${l.recOk}</h4><p>${l.recOkText(grade.value)}</p></div></div>`;else rec=`<div class="rec-box low"><div class="rec-icon">‚ö†Ô∏è</div><div class="rec-text"><h4>${l.recLow}</h4><p>${l.recLowText(lastGiven,grade.value)}</p></div></div>`;}
  document.getElementById('rec-box-container').innerHTML=rec;
  const gl2=document.getElementById('gift-list-detail');
  if(!pg.length){gl2.innerHTML=`<div class="empty-state"><div class="emoji">üéÅ</div><p>${l.noGifts}</p></div>`;}
  else{const s=[...pg].sort((a,b)=>new Date(b.date)-new Date(a.date));gl2.innerHTML=`<div class="card">${s.map(g=>{const ig=g.direction==='given';return`<div class="gift-item"><div class="gift-dir ${g.direction}">${ig?'‚Üë':'‚Üì'}</div><div class="gift-info"><div class="gift-occasion">${g.occasion}</div><div class="gift-date">${formatDate(g.date)} ¬∑ ${ig?l.givenShort:l.receivedShort}</div>${g.note?`<div class="gift-note">${g.note}</div>`:''}</div><div class="gift-amount ${g.direction}">${ig?'+':'-'}${g.amount}‚Ç¨</div></div>`;}).join('')}</div>`;}
  showView('person');
}

function editPerson(){
  const p=state.persons.find(x=>x.id===currentPersonId);if(!p)return;
  document.getElementById('edit-person-id').value=p.id;
  document.getElementById('input-name').value=p.name;
  document.getElementById('input-birthday').value=p.birthday||'';
  document.getElementById('input-note').value=p.note||'';
  populateGradeSelect('input-grade',p.gradeId);
  setEl('modal-person-title',t().editPerson);
  openModal('modal-add-person');
}

function renderGradeSettings(){
  document.getElementById('grade-settings-list').innerHTML=state.grades.map((g,i)=>`<div class="grade-row"><div class="grade-num">${i+1}</div><input type="text" value="${g.name}" onchange="updateGrade('${g.id}','name',this.value)" style="flex:1"><input type="number" value="${g.value}" min="0" step="5" onchange="updateGrade('${g.id}','value',+this.value)"><button onclick="removeGrade('${g.id}')" style="background:none;border:none;font-size:.97rem;cursor:pointer;color:var(--gray)">‚úï</button></div>`).join('');
}
function updateGrade(id,k,v){const g=state.grades.find(x=>x.id===id);if(g){g[k]=v;save();}}
function addGrade(){state.grades.push({id:uid(),name:'Neuer Grad / New Grade',value:30});save();renderGradeSettings();}
function removeGrade(id){state.grades=state.grades.filter(g=>g.id!==id);save();renderGradeSettings();}

function populateGradeSelect(selId,selectedId){
  const sel=document.getElementById(selId);if(!sel)return;
  sel.innerHTML=state.grades.map(g=>{const label=g.name.split('/')[state.lang==='de'?0:1]?.trim()||g.name;return`<option value="${g.id}"${g.id===selectedId?' selected':''}>${label} (${g.value}‚Ç¨)</option>`;}).join('');
}

function savePerson(){
  const name=document.getElementById('input-name').value.trim();if(!name)return;
  const gradeId=document.getElementById('input-grade').value;
  const birthday=document.getElementById('input-birthday').value;
  const note=document.getElementById('input-note').value.trim();
  const editId=document.getElementById('edit-person-id').value;
  if(editId){const p=state.persons.find(x=>x.id===editId);if(p){p.name=name;p.gradeId=gradeId;p.birthday=birthday;p.note=note;}}
  else state.persons.push({id:uid(),name,gradeId,birthday,note});
  save();closeModal('modal-add-person');showToast(t().toast_saved);
  trackEvent('Person',{a:editId?'edit':'new'});
  if(currentPersonId&&editId)openPersonDetail(currentPersonId);
  else{renderStats();renderPersonList();}
}

function openGiftFromHome(){
  const sel=document.getElementById('input-gift-person');
  const l=t();
  sel.innerHTML=`<option value="">${l.selectPerson}</option><option value="__new__">${l.newPerson}</option>`+state.persons.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  document.getElementById('inline-new-person').classList.remove('open');
  document.getElementById('new-person-name').value='';
  populateGradeSelect('new-person-grade',state.grades[0]?.id);
  document.getElementById('input-amount').value='';
  document.getElementById('input-occasion-select').value='';
  document.getElementById('input-occasion').value='';
  document.getElementById('input-occasion').style.display='none';
  document.getElementById('input-gift-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('input-gift-note').value='';
  giftDir='given';updateDirUI('dir-given','dir-received',giftDir);
  openModal('modal-add-gift');
}

function handleGiftPersonSelect(val){
  document.getElementById('inline-new-person').classList[val==='__new__'?'add':'remove']('open');
}

function openGiftFromPerson(){
  document.getElementById('input-amount2').value='';
  document.getElementById('input-occasion-select2').value='';
  document.getElementById('input-occasion2').value='';
  document.getElementById('input-occasion2').style.display='none';
  document.getElementById('input-gift-date2').value=new Date().toISOString().split('T')[0];
  document.getElementById('input-gift-note2').value='';
  giftDir2='given';updateDirUI('dir-given2','dir-received2',giftDir2);
  openModal('modal-add-gift-p');
}

function saveGift(){
  const l=t();
  let personId=document.getElementById('input-gift-person').value;
  if(personId==='__new__'){
    const newName=document.getElementById('new-person-name').value.trim();
    if(!newName){showToast('‚ö†Ô∏è Name fehlt');return;}
    const np={id:uid(),name:newName,gradeId:document.getElementById('new-person-grade').value,birthday:'',note:''};
    state.persons.push(np);personId=np.id;
    trackEvent('Person',{a:'new-inline'});
  }
  if(!personId){showToast(l.selectPersonFirst);return;}
  const amount=parseFloat(document.getElementById('input-amount').value);
  const occasion=getOccVal('input-occasion-select','input-occasion');
  const date=document.getElementById('input-gift-date').value;
  if(!amount||!occasion||!date)return;
  state.gifts.push({id:uid(),personId,direction:giftDir,amount,occasion,date,type:document.getElementById('input-type').value,note:document.getElementById('input-gift-note').value.trim()});
  save();closeModal('modal-add-gift');showToast(t().toast_saved);
  trackEvent('Gift',{dir:giftDir,amt:amount});
  renderStats();renderCurrentTab();
}

function saveGiftFromPerson(){
  if(!currentPersonId)return;
  const amount=parseFloat(document.getElementById('input-amount2').value);
  const occasion=getOccVal('input-occasion-select2','input-occasion2');
  const date=document.getElementById('input-gift-date2').value;
  if(!amount||!occasion||!date)return;
  state.gifts.push({id:uid(),personId:currentPersonId,direction:giftDir2,amount,occasion,date,type:document.getElementById('input-type2').value,note:document.getElementById('input-gift-note2').value.trim()});
  save();closeModal('modal-add-gift-p');showToast(t().toast_saved);
  trackEvent('Gift',{dir:giftDir2,amt:amount});
  openPersonDetail(currentPersonId);
}

function setDirection(d){giftDir=d;updateDirUI('dir-given','dir-received',d);}
function setDirection2(d){giftDir2=d;updateDirUI('dir-given2','dir-received2',d);}
function updateDirUI(gId,rId,dir){
  const l=t();
  const g=document.getElementById(gId),r=document.getElementById(rId);
  if(g){g.className='dir-btn given'+(dir==='given'?' active':'');g.textContent=l.given;}
  if(r){r.className='dir-btn received'+(dir==='received'?' active':'');r.textContent=l.received;}
}

function handleOccasionSelect(selId,inputId,val){
  const ci=document.getElementById(inputId);
  ci.style.display=val==='Sonstiges'?'block':'none';
  if(val!=='Sonstiges')ci.value=val;else{ci.value='';ci.focus();}
}
function getOccVal(selId,inputId){
  const sel=document.getElementById(selId),inp=document.getElementById(inputId);
  return sel.value==='Sonstiges'?inp.value.trim():sel.value;
}

function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');document.getElementById('edit-person-id').value='';}
function closeModalOnOverlay(e,id){if(e.target.id===id)closeModal(id);}

async function sendFeedback(){
  const l=t();const msg=document.getElementById('feedback-text').value.trim();const email=document.getElementById('feedback-email').value.trim();const status=document.getElementById('feedback-status');const btn=document.getElementById('btn-send-feedback');
  if(!msg){status.style.display='block';status.style.color='var(--red)';status.textContent=l.feedbackEmpty;return;}
  btn.textContent='‚è≥...';btn.disabled=true;status.style.display='none';
  try{const res=await fetch('https://formspree.io/f/mjgepbok',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({message:msg,email:email||'‚Äì',lang:state.lang,persons:state.persons.length,gifts:state.gifts.length})});
  if(res.ok){status.style.display='block';status.style.color='var(--green)';status.textContent=l.feedbackOk;document.getElementById('feedback-text').value='';document.getElementById('feedback-email').value='';trackEvent('Feedback');}else throw new Error();}
  catch{status.style.display='block';status.style.color='var(--red)';status.textContent=l.feedbackErr;}
  btn.textContent=l.feedbackSend;btn.disabled=false;
}

function formatDate(d){if(!d)return'';return new Date(d).toLocaleDateString(state.lang==='de'?'de-DE':'en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});}
function showToast(msg){const e=document.getElementById('toast');e.textContent=msg;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2200);}
function exportData(){const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='giftmemory-backup.json';a.click();}
function confirmReset(){if(confirm(t().confirmReset)){state.persons=[];state.gifts=[];save();showToast(t().toast_deleted);renderStats();renderPersonList();}}
function renderAll(){renderStats();renderCurrentTab();}

load();applyLang();switchTab(state.activeTab||'persons');renderStats();
</script>
</body>
</html>
