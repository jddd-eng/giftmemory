<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>GiftMemory</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<!-- PLAUSIBLE ANALYTICS â€“ ersetze "giftmemory.app" mit deiner Domain -->
<script defer data-domain="jddd-eng.github.io/giftmemory" src="https://plausible.io/js/script.tagged-events.js"></script>
<script>window.trackEvent = function(n,p){ if(typeof plausible==='function') plausible(n,{props:p||{}}); };</script>
<style>
:root {
  --cream: #FAF6F0;
  --cream2: #F2EBE0;
  --gold: #C8922A;
  --gold-light: #E8B84B;
  --gold-pale: #FDF3E0;
  --brown: #3D2B1F;
  --brown2: #6B4C35;
  --green: #2D6A4F;
  --green-pale: #D8F3DC;
  --red: #9B2226;
  --red-pale: #FFE5E5;
  --gray: #9E8E80;
  --shadow: 0 4px 24px rgba(61,43,31,0.10);
  --shadow-sm: 0 2px 8px rgba(61,43,31,0.08);
  --radius: 18px;
  --radius-sm: 10px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--cream);
  color: var(--brown);
  min-height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  overflow-x: hidden;
}
h1,h2,h3 { font-family: 'Playfair Display', serif; }

/* â”€â”€ VIEWS â”€â”€ */
.view { display: none; flex-direction: column; min-height: 100vh; animation: fadeIn 0.25s ease; }
.view.active { display: flex; }
@keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* â”€â”€ TOP BAR â”€â”€ */
.topbar {
  background: var(--cream);
  padding: 20px 20px 0;
  position: sticky; top: 0; z-index: 10;
}
.topbar-inner {
  display: flex; align-items: center; justify-content: space-between;
  padding-bottom: 14px;
  border-bottom: 1.5px solid var(--cream2);
}
.topbar h2 { font-size: 1.3rem; color: var(--brown); }
.back-btn {
  background: none; border: none; cursor: pointer;
  font-size: 1.2rem; color: var(--brown2); padding: 4px 8px 4px 0;
  font-family: 'DM Sans', sans-serif;
  display: flex; align-items: center; gap: 6px;
}
.lang-btn {
  background: var(--gold-pale); border: 1px solid var(--gold-light);
  border-radius: 20px; padding: 4px 12px; font-size: 0.75rem;
  font-weight: 600; color: var(--gold); cursor: pointer;
  font-family: 'DM Sans', sans-serif;
}

/* â”€â”€ HERO â”€â”€ */
.hero {
  background: linear-gradient(145deg, var(--brown) 0%, var(--brown2) 100%);
  padding: 48px 24px 36px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at 70% 30%, rgba(200,146,42,0.25) 0%, transparent 60%);
}
.hero-icon { font-size: 3rem; margin-bottom: 10px; display: block; position: relative; }
.hero h1 { font-size: 2.2rem; color: #FAF6F0; letter-spacing: -0.5px; position: relative; }
.hero p { color: rgba(250,246,240,0.65); font-size: 0.9rem; margin-top: 6px; position: relative; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: white;
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-sm);
  margin-bottom: 12px;
}
.content-area { padding: 20px; flex: 1; }

/* â”€â”€ STAT BAR â”€â”€ */
.stats-bar {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 10px; margin-bottom: 20px;
}
.stat-box {
  background: white; border-radius: var(--radius-sm);
  padding: 14px 10px; text-align: center;
  box-shadow: var(--shadow-sm);
}
.stat-box .val { font-size: 1.35rem; font-weight: 700; color: var(--gold); font-family: 'Playfair Display', serif; }
.stat-box .lbl { font-size: 0.7rem; color: var(--gray); margin-top: 2px; }

/* â”€â”€ PERSON LIST â”€â”€ */
.person-card {
  background: white; border-radius: var(--radius);
  padding: 16px 18px; margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  display: flex; align-items: center; gap: 14px;
  cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;
  border: 1.5px solid transparent;
}
.person-card:active { transform: scale(0.98); }
.person-card:hover { border-color: var(--gold-light); box-shadow: var(--shadow); }
.person-avatar {
  width: 48px; height: 48px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold-light), var(--gold));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem; font-weight: 700; color: white; flex-shrink: 0;
  font-family: 'Playfair Display', serif;
}
.person-info { flex: 1; min-width: 0; }
.person-name { font-weight: 600; font-size: 1rem; color: var(--brown); }
.person-sub { font-size: 0.78rem; color: var(--gray); margin-top: 2px; }
.person-badge {
  font-size: 0.72rem; font-weight: 600; padding: 3px 10px;
  border-radius: 20px; flex-shrink: 0;
}
.badge-ok { background: var(--green-pale); color: var(--green); }
.badge-low { background: #FFF3CD; color: #856404; }
.badge-none { background: var(--cream2); color: var(--gray); }

/* â”€â”€ GRADE PILLS â”€â”€ */
.grade-pill {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--gold-pale); color: var(--gold);
  border-radius: 20px; padding: 3px 10px;
  font-size: 0.75rem; font-weight: 600;
}

/* â”€â”€ GIFT LIST â”€â”€ */
.gift-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--cream2);
}
.gift-item:last-child { border-bottom: none; }
.gift-dir {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; flex-shrink: 0;
}
.gift-dir.given { background: var(--green-pale); }
.gift-dir.received { background: var(--red-pale); }
.gift-info { flex: 1; }
.gift-occasion { font-weight: 600; font-size: 0.9rem; }
.gift-date { font-size: 0.75rem; color: var(--gray); }
.gift-note { font-size: 0.75rem; color: var(--gray); font-style: italic; }
.gift-amount { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.05rem; }
.gift-amount.given { color: var(--green); }
.gift-amount.received { color: var(--red); }

/* â”€â”€ RECOMMENDATION BOX â”€â”€ */
.rec-box {
  border-radius: var(--radius);
  padding: 18px 20px;
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 14px;
}
.rec-box.ok { background: var(--green-pale); border: 1.5px solid #95D5B2; }
.rec-box.low { background: #FFF9E6; border: 1.5px solid #FFD166; }
.rec-box.none { background: var(--cream2); border: 1.5px solid var(--gold-light); }
.rec-icon { font-size: 1.8rem; flex-shrink: 0; }
.rec-text h4 { font-size: 0.9rem; font-weight: 700; margin-bottom: 3px; }
.rec-text p { font-size: 0.82rem; color: var(--brown2); line-height: 1.5; }

/* â”€â”€ FORMS â”€â”€ */
.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--brown2); margin-bottom: 6px; }
.form-group input, .form-group select, .form-group textarea {
  width: 100%; padding: 12px 14px;
  border: 1.5px solid var(--cream2); border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
  color: var(--brown); background: white;
  transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  outline: none; border-color: var(--gold);
}
.form-group textarea { resize: vertical; min-height: 80px; }
.direction-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.dir-btn {
  padding: 12px; border-radius: var(--radius-sm);
  border: 2px solid var(--cream2); background: white;
  cursor: pointer; font-family: 'DM Sans', sans-serif;
  font-size: 0.88rem; font-weight: 600; color: var(--gray);
  transition: all 0.15s; text-align: center;
}
.dir-btn.active.given { border-color: var(--green); background: var(--green-pale); color: var(--green); }
.dir-btn.active.received { border-color: var(--red); background: var(--red-pale); color: var(--red); }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  width: 100%; padding: 15px;
  border: none; border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
}
.btn-primary {
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
  color: white; box-shadow: 0 4px 14px rgba(200,146,42,0.35);
}
.btn-primary:active { transform: scale(0.98); }
.btn-secondary {
  background: var(--cream2); color: var(--brown2);
}
.btn-danger { background: var(--red-pale); color: var(--red); margin-top: 8px; }

/* â”€â”€ FAB â”€â”€ */
.fab {
  position: fixed; bottom: 88px; right: 20px;
  width: 58px; height: 58px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  color: white; font-size: 1.6rem; border: none;
  box-shadow: 0 6px 20px rgba(200,146,42,0.45);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s; z-index: 20;
}
.fab:active { transform: scale(0.92); }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state { text-align: center; padding: 48px 20px; color: var(--gray); }
.empty-state .emoji { font-size: 3rem; margin-bottom: 12px; }
.empty-state p { font-size: 0.9rem; line-height: 1.6; }

/* â”€â”€ SECTION TITLE â”€â”€ */
.section-title {
  font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--gray); margin-bottom: 10px; margin-top: 4px;
}

/* â”€â”€ GRADE SETTINGS â”€â”€ */
.grade-row {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 0; border-bottom: 1px solid var(--cream2);
}
.grade-row:last-child { border-bottom: none; }
.grade-num {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--gold-pale); color: var(--gold);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.85rem; flex-shrink: 0;
}
.grade-row input[type=text] {
  flex: 1; border: 1.5px solid var(--cream2); border-radius: 8px;
  padding: 8px 10px; font-family: 'DM Sans',sans-serif; font-size: 0.88rem;
  color: var(--brown);
}
.grade-row input[type=number] {
  width: 72px; border: 1.5px solid var(--cream2); border-radius: 8px;
  padding: 8px 10px; font-family: 'DM Sans',sans-serif; font-size: 0.88rem;
  color: var(--gold); font-weight: 700; text-align: center;
}
.grade-row input:focus { outline: none; border-color: var(--gold); }

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 480px;
  background: white; border-top: 1.5px solid var(--cream2);
  display: flex; z-index: 15; padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
  flex: 1; padding: 10px 0; display: flex; flex-direction: column;
  align-items: center; gap: 3px; cursor: pointer;
  font-size: 0.65rem; font-weight: 600; color: var(--gray);
  transition: color 0.15s; border: none; background: none;
  font-family: 'DM Sans', sans-serif;
}
.nav-item.active { color: var(--gold); }
.nav-item .nav-icon { font-size: 1.3rem; }
.scroll-content { flex: 1; overflow-y: auto; padding-bottom: 80px; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--brown); color: white; padding: 12px 24px;
  border-radius: 30px; font-size: 0.88rem; font-weight: 500;
  opacity: 0; transition: all 0.3s; z-index: 100; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(61,43,31,0.5);
  z-index: 50; display: none; align-items: flex-end;
  backdrop-filter: blur(3px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--cream); width: 100%; max-width: 480px; margin: 0 auto;
  border-radius: 24px 24px 0 0; padding: 24px 20px 40px;
  max-height: 90vh; overflow-y: auto;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle { width: 40px; height: 4px; background: var(--cream2); border-radius: 2px; margin: 0 auto 20px; }
.modal h3 { font-size: 1.3rem; margin-bottom: 20px; color: var(--brown); }

/* Search */
.search-bar {
  display: flex; align-items: center; gap: 10px;
  background: white; border: 1.5px solid var(--cream2);
  border-radius: var(--radius-sm); padding: 10px 14px;
  margin-bottom: 16px;
}
.search-bar input {
  border: none; background: none; flex: 1;
  font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
  color: var(--brown);
}
.search-bar input:focus { outline: none; }
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: HOME -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view active" id="view-home">
  <div class="hero">
    <span class="hero-icon">ğŸ</span>
    <h1>GiftMemory</h1>
    <p id="hero-sub">Dein soziales Geschenke-GedÃ¤chtnis</p>
  </div>
  <div class="scroll-content">
    <div class="content-area">
      <div class="stats-bar" id="stats-bar"></div>
      <div class="section-title" id="lbl-people">Personen</div>
      <div class="search-bar">
        <span>ğŸ”</span>
        <input type="text" id="search-input" placeholder="Suchen..." oninput="renderPersonList()">
      </div>
      <div id="person-list"></div>
    </div>
  </div>
  <button class="fab" onclick="openModal('modal-add-person')" title="Person hinzufÃ¼gen">ï¼‹</button>
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="showView('home')"><span class="nav-icon">ğŸ‘¥</span><span id="nav-people">Personen</span></button>
    <button class="nav-item" onclick="showView('gifts')"><span class="nav-icon">ğŸ</span><span id="nav-gifts">Geschenke</span></button>
    <button class="nav-item" onclick="showView('occasions')"><span class="nav-icon">ğŸ”</span><span id="nav-occasions0">AnlÃ¤sse</span></button>
    <button class="nav-item" onclick="showView('settings')"><span class="nav-icon">âš™ï¸</span><span id="nav-settings">Einstellungen</span></button>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: PERSON DETAIL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-person">
  <div class="topbar">
    <div class="topbar-inner">
      <button class="back-btn" onclick="showView('home')">â† <span id="lbl-back">ZurÃ¼ck</span></button>
      <div style="display:flex;gap:8px">
        <button class="lang-btn" onclick="editPerson()" style="background:var(--gold-pale);color:var(--gold)">âœï¸</button>
        <button class="lang-btn" onclick="toggleLang()" id="lang-btn2">EN</button>
      </div>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area">
      <div id="person-detail-header" style="text-align:center;padding:20px 0 24px"></div>
      <div id="rec-box-container"></div>
      <div class="section-title" id="lbl-history">Verlauf</div>
      <div id="gift-list-detail"></div>
    </div>
  </div>
  <button class="fab" onclick="openModal('modal-add-gift')" title="Geschenk eintragen">ï¼‹</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: ALL GIFTS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-gifts">
  <div class="topbar">
    <div class="topbar-inner">
      <h2 id="lbl-all-gifts">Alle Geschenke</h2>
      <button class="lang-btn" onclick="toggleLang()" id="lang-btn3">EN</button>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area">
      <div id="all-gifts-list"></div>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-item" onclick="showView('home')"><span class="nav-icon">ğŸ‘¥</span><span id="nav-people2">Personen</span></button>
    <button class="nav-item active" onclick="showView('gifts')"><span class="nav-icon">ğŸ</span><span id="nav-gifts2">Geschenke</span></button>
    <button class="nav-item" onclick="showView('occasions')"><span class="nav-icon">ğŸ”</span><span id="nav-occasions2">AnlÃ¤sse</span></button>
    <button class="nav-item" onclick="showView('settings')"><span class="nav-icon">âš™ï¸</span><span id="nav-settings2">Einstellungen</span></button>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: OCCASIONS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-occasions">
  <div class="topbar">
    <div class="topbar-inner">
      <h2 id="lbl-occasions-title">AnlÃ¤sse</h2>
      <button class="lang-btn" onclick="toggleLang()" id="lang-btn5">EN</button>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area">
      <p id="lbl-occasions-sub" style="font-size:0.82rem;color:var(--gray);margin-bottom:14px">Suche nach Anlass-Typ â€“ egal wer die Person war</p>
      <div class="search-bar">
        <span>ğŸ”</span>
        <input type="text" id="occasion-search" placeholder="z.B. Beerdigung, Hochzeit..." oninput="renderOccasions()">
      </div>
      <div style="margin-bottom:14px">
        <select id="occasion-grade-filter" onchange="renderOccasions()" style="width:100%;padding:10px 14px;border:1.5px solid var(--cream2);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.9rem;color:var(--brown);background:white;-webkit-appearance:none">
          <option value="">â€” Alle Grade / All Grades â€”</option>
        </select>
      </div>
      <div id="occasions-list"></div>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-item" onclick="showView('home')"><span class="nav-icon">ğŸ‘¥</span><span id="nav-people4">Personen</span></button>
    <button class="nav-item" onclick="showView('gifts')"><span class="nav-icon">ğŸ</span><span id="nav-gifts4">Geschenke</span></button>
    <button class="nav-item active" onclick="showView('occasions')"><span class="nav-icon">ğŸ”</span><span id="nav-occasions">AnlÃ¤sse</span></button>
    <button class="nav-item" onclick="showView('settings')"><span class="nav-icon">âš™ï¸</span><span id="nav-settings4">Einstellungen</span></button>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: SETTINGS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-settings">
  <div class="topbar">
    <div class="topbar-inner">
      <h2 id="lbl-settings-title">Einstellungen</h2>
      <button class="lang-btn" onclick="toggleLang()" id="lang-btn4">EN</button>
    </div>
  </div>
  <div class="scroll-content">
    <div class="content-area">
      <div class="section-title" id="lbl-grades-title">Beziehungsgrade</div>
      <div class="card">
        <div id="grade-settings-list"></div>
        <button class="btn btn-secondary" style="margin-top:14px" onclick="addGrade()" id="btn-add-grade">+ Grad hinzufÃ¼gen</button>
      </div>
      <div class="section-title" style="margin-top:20px" id="lbl-lang-title">Sprache / Language</div>
      <div class="card" style="display:flex;gap:10px">
        <button class="btn" onclick="setLang('de')" id="btn-de" style="flex:1">ğŸ‡©ğŸ‡ª Deutsch</button>
        <button class="btn" onclick="setLang('en')" id="btn-en" style="flex:1">ğŸ‡¬ğŸ‡§ English</button>
      </div>
      <div class="section-title" style="margin-top:20px" id="lbl-feedback-title">Feedback</div>
      <div class="card">
        <p id="lbl-feedback-sub" style="font-size:0.83rem;color:var(--gray);margin-bottom:14px;line-height:1.6">Ideen, WÃ¼nsche oder Fehler? Schreib mir direkt â€“ ich lese alles persÃ¶nlich.</p>
        <div class="form-group">
          <label id="lbl-feedback-msg">Deine Nachricht</label>
          <textarea id="feedback-text" rows="3" placeholder="z.B. Ich vermisse die Funktion..."></textarea>
        </div>
        <div class="form-group">
          <label id="lbl-feedback-email">Deine E-Mail (optional â€“ falls du eine Antwort mÃ¶chtest)</label>
          <input type="email" id="feedback-email" placeholder="name@beispiel.com">
        </div>
        <button class="btn btn-primary" onclick="sendFeedback()" id="btn-send-feedback">ğŸ’¬ Feedback senden</button>
        <div id="feedback-status" style="margin-top:10px;font-size:0.83rem;display:none"></div>
      </div>

      <div class="section-title" style="margin-top:20px" id="lbl-data-title">Daten</div>
      <div class="card">
        <button class="btn btn-secondary" onclick="exportData()" id="btn-export">ğŸ“¤ Daten exportieren</button>
        <button class="btn btn-danger" onclick="confirmReset()" id="btn-reset">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>
      </div>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-item" onclick="showView('home')"><span class="nav-icon">ğŸ‘¥</span><span id="nav-people3">Personen</span></button>
    <button class="nav-item" onclick="showView('gifts')"><span class="nav-icon">ğŸ</span><span id="nav-gifts3">Geschenke</span></button>
    <button class="nav-item" onclick="showView('occasions')"><span class="nav-icon">ğŸ”</span><span id="nav-occasions3">AnlÃ¤sse</span></button>
    <button class="nav-item active" onclick="showView('settings')"><span class="nav-icon">âš™ï¸</span><span id="nav-settings3">Einstellungen</span></button>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODALS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Add/Edit Person -->
<div class="modal-overlay" id="modal-add-person" onclick="closeModalOnOverlay(event,'modal-add-person')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="modal-person-title">Person hinzufÃ¼gen</h3>
    <input type="hidden" id="edit-person-id">
    <div class="form-group">
      <label id="lbl-name">Name</label>
      <input type="text" id="input-name" placeholder="z.B. Mama, Klaus, Sarah...">
    </div>
    <div class="form-group">
      <label id="lbl-grade">Beziehungsgrad</label>
      <select id="input-grade"></select>
    </div>
    <div class="form-group">
      <label id="lbl-birthday">Geburtstag (optional)</label>
      <input type="date" id="input-birthday">
    </div>
    <div class="form-group">
      <label id="lbl-note">Notiz (optional)</label>
      <textarea id="input-note" rows="2"></textarea>
    </div>
    <button class="btn btn-primary" onclick="savePerson()" id="btn-save-person">Speichern</button>
    <button class="btn btn-secondary" style="margin-top:8px" onclick="closeModal('modal-add-person')" id="btn-cancel">Abbrechen</button>
  </div>
</div>

<!-- Add Gift -->
<div class="modal-overlay" id="modal-add-gift" onclick="closeModalOnOverlay(event,'modal-add-gift')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="modal-gift-title">Geschenk eintragen</h3>
    <div class="form-group">
      <label id="lbl-direction">Richtung</label>
      <div class="direction-toggle">
        <button class="dir-btn given active" id="dir-given" onclick="setDirection('given')" id="btn-given">â†‘ Gegeben</button>
        <button class="dir-btn received" id="dir-received" onclick="setDirection('received')" id="btn-received">â†“ Bekommen</button>
      </div>
    </div>
    <div class="form-group">
      <label id="lbl-amount">Betrag (â‚¬)</label>
      <input type="number" id="input-amount" placeholder="0" min="0" step="1">
    </div>
    <div class="form-group">
      <label id="lbl-occasion">Anlass</label>
      <select id="input-occasion-select" onchange="handleOccasionSelect(this.value)" style="margin-bottom:6px">
        <option value="">â€” Anlass wÃ¤hlen / Choose occasion â€”</option>
        <optgroup label="ğŸ‡©ğŸ‡ª HÃ¤ufige AnlÃ¤sse">
          <option value="Geburtstag">ğŸ‚ Geburtstag / Birthday</option>
          <option value="Hochzeit">ğŸ’ Hochzeit / Wedding</option>
          <option value="Geburt">ğŸ‘¶ Geburt / Birth</option>
          <option value="Taufe">â›ª Taufe / Baptism</option>
          <option value="Beerdigung / Kondolenz">ğŸ•¯ï¸ Beerdigung / Funeral</option>
          <option value="Kommunion / Konfirmation">ğŸ™ Kommunion / Konfirmation</option>
          <option value="Weihnachten">ğŸ„ Weihnachten / Christmas</option>
          <option value="Ostern">ğŸ£ Ostern / Easter</option>
          <option value="Muttertag">ğŸ’ Muttertag / Mother's Day</option>
          <option value="Vatertag">ğŸ‘” Vatertag / Father's Day</option>
          <option value="Valentinstag">â¤ï¸ Valentinstag / Valentine's Day</option>
          <option value="JubilÃ¤um">ğŸ¥‚ JubilÃ¤um / Anniversary</option>
          <option value="Abschluss / Diplom">ğŸ“ Abschluss / Graduation</option>
          <option value="Einzug / Umzug">ğŸ  Einzug / Moving in</option>
          <option value="Pensionierung">ğŸŒ… Pensionierung / Retirement</option>
          <option value="Krankheit / Genesung">ğŸŒ· Krankheit / Get well</option>
          <option value="Sonstiges">âœï¸ Sonstiges / Other...</option>
        </optgroup>
      </select>
      <input type="text" id="input-occasion" placeholder="Anlass eingeben..." style="display:none">
    </div>
    <div class="form-group">
      <label id="lbl-date">Datum</label>
      <input type="date" id="input-gift-date">
    </div>
    <div class="form-group">
      <label id="lbl-type">Art</label>
      <select id="input-type">
        <option value="money">Geldgeschenk / Money gift</option>
        <option value="physical">Sachgeschenk / Physical gift</option>
        <option value="both">Beides / Both</option>
      </select>
    </div>
    <div class="form-group">
      <label id="lbl-gift-note">Notiz (optional)</label>
      <textarea id="input-gift-note" rows="2"></textarea>
    </div>
    <button class="btn btn-primary" onclick="saveGift()" id="btn-save-gift">Speichern</button>
    <button class="btn btn-secondary" style="margin-top:8px" onclick="closeModal('modal-add-gift')" id="btn-cancel2">Abbrechen</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  lang: 'de',
  grades: [
    { id: 'g1', name: 'Engste Familie / Closest Family', value: 200 },
    { id: 'g2', name: 'Nahe Verwandte / Close Relatives', value: 100 },
    { id: 'g3', name: 'Entfernte Verwandte / Distant Relatives', value: 50 },
    { id: 'g4', name: 'Enge Freunde / Close Friends', value: 60 },
    { id: 'g5', name: 'Bekannte / Acquaintances', value: 25 },
  ],
  persons: [],
  gifts: [],
};
let currentPersonId = null;
let giftDirection = 'given';

function save() {
  try { localStorage.setItem('giftmemory_v1', JSON.stringify(state)); } catch(e) {}
}
function load() {
  try {
    const raw = localStorage.getItem('giftmemory_v1');
    if (raw) state = { ...state, ...JSON.parse(raw) };
  } catch(e) {}
}
function uid() { return 'id_' + Math.random().toString(36).substr(2,9); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// I18N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  de: {
    heroSub: 'Dein soziales Geschenke-GedÃ¤chtnis',
    people: 'Personen', gifts: 'Geschenke', settings: 'Einstellungen',
    back: 'ZurÃ¼ck', history: 'Verlauf', allGifts: 'Alle Geschenke',
    gradesTitle: 'Beziehungsgrade', langTitle: 'Sprache', dataTitle: 'Daten',
    addPerson: 'Person hinzufÃ¼gen', editPerson: 'Person bearbeiten',
    name: 'Name', grade: 'Beziehungsgrad', birthday: 'Geburtstag (optional)',
    note: 'Notiz (optional)', save: 'Speichern', cancel: 'Abbrechen',
    addGift: 'Geschenk eintragen', direction: 'Richtung',
    given: 'â†‘ Gegeben', received: 'â†“ Bekommen',
    amount: 'Betrag (â‚¬)', occasion: 'Anlass', date: 'Datum',
    type: 'Art', giftNote: 'Notiz (optional)',
    addGradeBtn: '+ Grad hinzufÃ¼gen',
    exportBtn: 'ğŸ“¤ Daten exportieren', resetBtn: 'ğŸ—‘ï¸ Alle Daten lÃ¶schen',
    statPeople: 'Personen', statGiven: 'Gegeben', statReceived: 'Bekommen',
    recOk: 'âœ… Passt gut!', recLow: 'âš ï¸ Etwas wenig',
    recNone: 'ğŸ’¡ Noch kein Geschenk',
    recOkText: (r) => `Richtwert: ${r}â‚¬ â€“ du liegst gut im Bereich.`,
    recLowText: (last, r) => `Letztes Geschenk: ${last}â‚¬ Â· Richtwert: ${r}â‚¬`,
    recNoneText: (r) => `Richtwert fÃ¼r diesen Grad: ${r}â‚¬`,
    noPersons: 'Noch keine Personen.\nTippe auf ï¼‹ um jemanden hinzuzufÃ¼gen.',
    noGifts: 'Noch keine EintrÃ¤ge.\nTippe auf ï¼‹ um ein Geschenk einzutragen.',
    noAllGifts: 'Noch keine Geschenke eingetragen.',
    toast_saved: 'Gespeichert âœ“',
    toast_deleted: 'GelÃ¶scht âœ“',
    confirmReset: 'Wirklich alle Daten lÃ¶schen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.',
    searchPlaceholder: 'Suchen...',
    occasionPlaceholder: 'z.B. Geburtstag, Weihnachten...',
    namePlaceholder: 'z.B. Mama, Klaus, Sarah...',
    givenShort: 'Gegeben', receivedShort: 'Bekommen',
    occasions: 'AnlÃ¤sse', occasionsSub: 'Suche nach Anlass-Typ â€“ egal wer die Person war',
    allGrades: 'â€” Alle Grade â€”', noOccasions: 'Keine EintrÃ¤ge gefunden.',
    gradeLabel: 'Grad', avgLabel: 'Ã˜', totalLabel: 'Gesamt',
    feedbackTitle: 'Feedback',
    feedbackSub: 'Ideen, WÃ¼nsche oder Fehler? Schreib mir direkt â€“ ich lese alles persÃ¶nlich.',
    feedbackMsg: 'Deine Nachricht',
    feedbackEmail: 'Deine E-Mail (optional â€“ falls du eine Antwort mÃ¶chtest)',
    feedbackSend: 'ğŸ’¬ Feedback senden',
    feedbackOk: 'âœ… Danke! Deine Nachricht ist angekommen.',
    feedbackErr: 'âŒ Fehler beim Senden â€“ bitte versuche es nochmals.',
    feedbackEmpty: 'âš ï¸ Bitte schreib eine Nachricht.',
  },
  en: {
    heroSub: 'Your social gift memory',
    people: 'People', gifts: 'Gifts', settings: 'Settings',
    back: 'Back', history: 'History', allGifts: 'All Gifts',
    gradesTitle: 'Relationship Grades', langTitle: 'Language', dataTitle: 'Data',
    addPerson: 'Add Person', editPerson: 'Edit Person',
    name: 'Name', grade: 'Relationship Grade', birthday: 'Birthday (optional)',
    note: 'Note (optional)', save: 'Save', cancel: 'Cancel',
    addGift: 'Add Gift', direction: 'Direction',
    given: 'â†‘ Given', received: 'â†“ Received',
    amount: 'Amount (â‚¬)', occasion: 'Occasion', date: 'Date',
    type: 'Type', giftNote: 'Note (optional)',
    addGradeBtn: '+ Add Grade',
    exportBtn: 'ğŸ“¤ Export Data', resetBtn: 'ğŸ—‘ï¸ Delete All Data',
    statPeople: 'People', statGiven: 'Given', statReceived: 'Received',
    recOk: 'âœ… Looks good!', recLow: 'âš ï¸ A bit low',
    recNone: 'ğŸ’¡ No gift yet',
    recOkText: (r) => `Benchmark: â‚¬${r} â€“ you're in range.`,
    recLowText: (last, r) => `Last gift: â‚¬${last} Â· Benchmark: â‚¬${r}`,
    recNoneText: (r) => `Benchmark for this grade: â‚¬${r}`,
    noPersons: 'No people yet.\nTap ï¼‹ to add someone.',
    noGifts: 'No entries yet.\nTap ï¼‹ to add a gift.',
    noAllGifts: 'No gifts recorded yet.',
    toast_saved: 'Saved âœ“',
    toast_deleted: 'Deleted âœ“',
    confirmReset: 'Really delete all data? This cannot be undone.',
    searchPlaceholder: 'Search...',
    occasionPlaceholder: 'e.g. Birthday, Christmas...',
    namePlaceholder: 'e.g. Mom, Klaus, Sarah...',
    givenShort: 'Given', receivedShort: 'Received',
    occasions: 'Occasions', occasionsSub: 'Search by occasion type â€“ regardless of who the person was',
    allGrades: 'â€” All Grades â€”', noOccasions: 'No entries found.',
    gradeLabel: 'Grade', avgLabel: 'Avg', totalLabel: 'Total',
    feedbackTitle: 'Feedback',
    feedbackSub: 'Ideas, wishes or bugs? Write to me directly â€“ I read everything personally.',
    feedbackMsg: 'Your message',
    feedbackEmail: 'Your email (optional â€“ if you want a reply)',
    feedbackSend: 'ğŸ’¬ Send feedback',
    feedbackOk: 'âœ… Thank you! Your message has been received.',
    feedbackErr: 'âŒ Error sending â€“ please try again.',
    feedbackEmpty: 'âš ï¸ Please write a message.',
  }
};
const t = () => T[state.lang];

function applyLang() {
  const l = t();
  document.getElementById('hero-sub').textContent = l.heroSub;
  ['nav-people','nav-people2','nav-people3','nav-people4'].forEach(id => { const el=document.getElementById(id); if(el) el.textContent=l.people; });
  ['nav-gifts','nav-gifts2','nav-gifts3','nav-gifts4'].forEach(id => { const el=document.getElementById(id); if(el) el.textContent=l.gifts; });
  ['nav-settings','nav-settings2','nav-settings3','nav-settings4'].forEach(id => { const el=document.getElementById(id); if(el) el.textContent=l.settings; });
  ['nav-occasions','nav-occasions0','nav-occasions2','nav-occasions3'].forEach(id => { const el=document.getElementById(id); if(el) el.textContent=l.occasions; });
  setEl('lbl-back', l.back); setEl('lbl-people', l.people);
  setEl('lbl-history', l.history); setEl('lbl-all-gifts', l.allGifts);
  setEl('lbl-settings-title', l.settings); setEl('lbl-grades-title', l.gradesTitle);
  setEl('lbl-lang-title', l.langTitle); setEl('lbl-data-title', l.dataTitle);
  setEl('lbl-name', l.name); setEl('lbl-grade', l.grade);
  setEl('lbl-birthday', l.birthday); setEl('lbl-note', l.note);
  setEl('btn-save-person', l.save); setEl('btn-cancel', l.cancel); setEl('btn-cancel2', l.cancel);
  setEl('lbl-direction', l.direction);
  setEl('dir-given', l.given); setEl('dir-received', l.received);
  setEl('lbl-amount', l.amount); setEl('lbl-occasion', l.occasion);
  setEl('lbl-date', l.date); setEl('lbl-type', l.type);
  setEl('lbl-gift-note', l.giftNote); setEl('btn-save-gift', l.save);
  setEl('btn-add-grade', l.addGradeBtn);
  setEl('btn-export', l.exportBtn); setEl('btn-reset', l.resetBtn);
  setEl('modal-gift-title', l.addGift);
  const si = document.getElementById('search-input'); if(si) si.placeholder = l.searchPlaceholder;
  setEl('lbl-occasions-title', l.occasions);
  setEl('lbl-occasions-sub', l.occasionsSub);
  setEl('lbl-feedback-title', l.feedbackTitle);
  setEl('lbl-feedback-sub', l.feedbackSub);
  setEl('lbl-feedback-msg', l.feedbackMsg);
  setEl('lbl-feedback-email', l.feedbackEmail);
  setEl('btn-send-feedback', l.feedbackSend);
  ['lang-btn2','lang-btn3','lang-btn4','lang-btn5'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.textContent = state.lang === 'de' ? 'EN' : 'DE';
  });
  const btnDe = document.getElementById('btn-de');
  const btnEn = document.getElementById('btn-en');
  if(btnDe) btnDe.style.fontWeight = state.lang==='de' ? '700' : '400';
  if(btnEn) btnEn.style.fontWeight = state.lang==='en' ? '700' : '400';
}
function setEl(id, val) { const el=document.getElementById(id); if(el) el.textContent=val; }
function setLang(lang) { state.lang = lang; save(); applyLang(); renderAll(); }
function toggleLang() { setLang(state.lang === 'de' ? 'en' : 'de'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  if(name === 'home') renderPersonList();
  if(name === 'gifts') renderAllGifts();
  if(name === 'occasions') renderOccasions();
  if(name === 'settings') renderGradeSettings();
  trackEvent('Tab geÃ¶ffnet', { tab: name });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PERSON LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPersonList() {
  const l = t();
  const search = (document.getElementById('search-input')?.value || '').toLowerCase();
  const filtered = state.persons.filter(p => p.name.toLowerCase().includes(search));

  // Stats
  const totalGiven = state.gifts.filter(g=>g.direction==='given').reduce((s,g)=>s+g.amount,0);
  const totalReceived = state.gifts.filter(g=>g.direction==='received').reduce((s,g)=>s+g.amount,0);
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-box"><div class="val">${state.persons.length}</div><div class="lbl">${l.statPeople}</div></div>
    <div class="stat-box"><div class="val">${totalGiven}â‚¬</div><div class="lbl">${l.statGiven}</div></div>
    <div class="stat-box"><div class="val">${totalReceived}â‚¬</div><div class="lbl">${l.statReceived}</div></div>
  `;

  const list = document.getElementById('person-list');
  if(!filtered.length) {
    list.innerHTML = `<div class="empty-state"><div class="emoji">ğŸ‘¤</div><p>${l.noPersons}</p></div>`;
    return;
  }
  list.innerHTML = filtered.map(p => {
    const grade = state.grades.find(g => g.id === p.gradeId);
    const personGifts = state.gifts.filter(g => g.personId === p.id && g.direction === 'given');
    const lastGiven = personGifts.length ? personGifts.sort((a,b)=>new Date(b.date)-new Date(a.date))[0].amount : null;
    let badge = '', badgeClass = 'badge-none';
    if(lastGiven !== null && grade) {
      if(lastGiven >= grade.value * 0.8) { badge = 'âœ…'; badgeClass = 'badge-ok'; }
      else { badge = 'âš ï¸'; badgeClass = 'badge-low'; }
    }
    const gradeLabel = grade ? grade.name.split('/')[state.lang==='de'?0:1]?.trim() || grade.name : '';
    return `<div class="person-card" onclick="openPersonDetail('${p.id}')">
      <div class="person-avatar">${p.name.charAt(0).toUpperCase()}</div>
      <div class="person-info">
        <div class="person-name">${p.name}</div>
        <div class="person-sub">${gradeLabel}${grade?' Â· '+grade.value+'â‚¬':''}</div>
      </div>
      ${badge ? `<span class="person-badge ${badgeClass}">${badge}</span>` : ''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSON DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPersonDetail(personId) {
  currentPersonId = personId;
  const p = state.persons.find(x => x.id === personId);
  if(!p) return;
  const grade = state.grades.find(g => g.id === p.gradeId);
  const l = t();
  const gradeLabel = grade ? grade.name.split('/')[state.lang==='de'?0:1]?.trim() || grade.name : '';

  document.getElementById('person-detail-header').innerHTML = `
    <div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#E8B84B,#C8922A);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-family:'Playfair Display',serif;color:white;font-weight:700;margin:0 auto 12px">${p.name.charAt(0).toUpperCase()}</div>
    <h2 style="font-size:1.6rem;color:var(--brown)">${p.name}</h2>
    <div style="margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px">
      <span class="grade-pill">â­ ${gradeLabel}</span>
      ${grade ? `<span class="grade-pill">${grade.value}â‚¬</span>` : ''}
    </div>
    ${p.note ? `<p style="margin-top:10px;font-size:0.82rem;color:var(--gray);font-style:italic">${p.note}</p>` : ''}
  `;

  // Recommendation
  const personGifts = state.gifts.filter(g => g.personId === personId);
  const givenGifts = personGifts.filter(g => g.direction === 'given').sort((a,b)=>new Date(b.date)-new Date(a.date));
  const lastGiven = givenGifts.length ? givenGifts[0].amount : null;
  let recHtml = '';
  if(grade) {
    if(lastGiven === null) {
      recHtml = `<div class="rec-box none"><div class="rec-icon">ğŸ’¡</div><div class="rec-text"><h4>${l.recNone}</h4><p>${l.recNoneText(grade.value)}</p></div></div>`;
    } else if(lastGiven >= grade.value * 0.8) {
      recHtml = `<div class="rec-box ok"><div class="rec-icon">âœ…</div><div class="rec-text"><h4>${l.recOk}</h4><p>${l.recOkText(grade.value)}</p></div></div>`;
    } else {
      recHtml = `<div class="rec-box low"><div class="rec-icon">âš ï¸</div><div class="rec-text"><h4>${l.recLow}</h4><p>${l.recLowText(lastGiven, grade.value)}</p></div></div>`;
    }
  }
  document.getElementById('rec-box-container').innerHTML = recHtml;

  // Gift list
  const giftList = document.getElementById('gift-list-detail');
  if(!personGifts.length) {
    giftList.innerHTML = `<div class="empty-state"><div class="emoji">ğŸ</div><p>${l.noGifts}</p></div>`;
  } else {
    const sorted = [...personGifts].sort((a,b)=>new Date(b.date)-new Date(a.date));
    giftList.innerHTML = `<div class="card">${sorted.map(g => {
      const isGiven = g.direction === 'given';
      return `<div class="gift-item">
        <div class="gift-dir ${g.direction}">${isGiven ? 'â†‘' : 'â†“'}</div>
        <div class="gift-info">
          <div class="gift-occasion">${g.occasion}</div>
          <div class="gift-date">${formatDate(g.date)} Â· ${isGiven ? l.givenShort : l.receivedShort}</div>
          ${g.note ? `<div class="gift-note">${g.note}</div>` : ''}
        </div>
        <div class="gift-amount ${g.direction}">${isGiven?'+':'-'}${g.amount}â‚¬</div>
      </div>`;
    }).join('')}</div>`;
  }

  showView('person');
}

function editPerson() {
  const p = state.persons.find(x => x.id === currentPersonId);
  if(!p) return;
  document.getElementById('edit-person-id').value = p.id;
  document.getElementById('input-name').value = p.name;
  document.getElementById('input-birthday').value = p.birthday || '';
  document.getElementById('input-note').value = p.note || '';
  populateGradeSelect(p.gradeId);
  setEl('modal-person-title', t().editPerson);
  openModal('modal-add-person');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALL GIFTS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAllGifts() {
  const l = t();
  const sorted = [...state.gifts].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const el = document.getElementById('all-gifts-list');
  if(!sorted.length) {
    el.innerHTML = `<div class="empty-state"><div class="emoji">ğŸ</div><p>${l.noAllGifts}</p></div>`;
    return;
  }
  el.innerHTML = `<div class="card">${sorted.map(g => {
    const p = state.persons.find(x => x.id === g.personId);
    const isGiven = g.direction === 'given';
    return `<div class="gift-item">
      <div class="gift-dir ${g.direction}">${isGiven ? 'â†‘' : 'â†“'}</div>
      <div class="gift-info">
        <div class="gift-occasion">${g.occasion}</div>
        <div class="gift-date">${p ? p.name : '?'} Â· ${formatDate(g.date)}</div>
        ${g.note ? `<div class="gift-note">${g.note}</div>` : ''}
      </div>
      <div class="gift-amount ${g.direction}">${isGiven?'+':'-'}${g.amount}â‚¬</div>
    </div>`;
  }).join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRADE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGradeSettings() {
  const list = document.getElementById('grade-settings-list');
  list.innerHTML = state.grades.map((g, i) => `
    <div class="grade-row">
      <div class="grade-num">${i+1}</div>
      <input type="text" value="${g.name}" onchange="updateGrade('${g.id}','name',this.value)" style="flex:1">
      <input type="number" value="${g.value}" min="0" step="5" onchange="updateGrade('${g.id}','value',+this.value)">
      <button onclick="removeGrade('${g.id}')" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--gray)">âœ•</button>
    </div>
  `).join('');
}
function updateGrade(id, key, val) {
  const g = state.grades.find(x => x.id === id);
  if(g) { g[key] = val; save(); }
}
function addGrade() {
  state.grades.push({ id: uid(), name: 'Neuer Grad / New Grade', value: 30 });
  save(); renderGradeSettings();
}
function removeGrade(id) {
  state.grades = state.grades.filter(g => g.id !== id);
  save(); renderGradeSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE PERSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateGradeSelect(selectedId) {
  const sel = document.getElementById('input-grade');
  sel.innerHTML = state.grades.map(g => {
    const label = g.name.split('/')[state.lang==='de'?0:1]?.trim() || g.name;
    return `<option value="${g.id}" ${g.id===selectedId?'selected':''}>${label} (${g.value}â‚¬)</option>`;
  }).join('');
}
function openModal(id) {
  if(id === 'modal-add-person') {
    const editId = document.getElementById('edit-person-id').value;
    if(!editId) {
      document.getElementById('input-name').value='';
      document.getElementById('input-birthday').value='';
      document.getElementById('input-note').value='';
      setEl('modal-person-title', t().addPerson);
    }
    populateGradeSelect(state.grades[0]?.id);
  }
  if(id === 'modal-add-gift') {
    document.getElementById('input-amount').value='';
    document.getElementById('input-occasion-select').value='';
    document.getElementById('input-occasion').value='';
    document.getElementById('input-occasion').style.display='none';
    document.getElementById('input-gift-date').value=new Date().toISOString().split('T')[0];
    document.getElementById('input-gift-note').value='';
    giftDirection = 'given';
    updateDirectionUI();
  }
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.getElementById('edit-person-id').value = '';
}
function closeModalOnOverlay(e, id) {
  if(e.target.id === id) closeModal(id);
}
function savePerson() {
  const name = document.getElementById('input-name').value.trim();
  if(!name) return;
  const gradeId = document.getElementById('input-grade').value;
  const birthday = document.getElementById('input-birthday').value;
  const note = document.getElementById('input-note').value.trim();
  const editId = document.getElementById('edit-person-id').value;
  if(editId) {
    const p = state.persons.find(x => x.id === editId);
    if(p) { p.name=name; p.gradeId=gradeId; p.birthday=birthday; p.note=note; }
  } else {
    state.persons.push({ id: uid(), name, gradeId, birthday, note });
  }
  save(); closeModal('modal-add-person');
  showToast(t().toast_saved);
  trackEvent('Person gespeichert', { aktion: editId ? 'bearbeitet' : 'neu' });
  if(currentPersonId && editId) openPersonDetail(currentPersonId);
  else renderPersonList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE GIFT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDirection(dir) {
  giftDirection = dir;
  updateDirectionUI();
}
function updateDirectionUI() {
  const l = t();
  const btnG = document.getElementById('dir-given');
  const btnR = document.getElementById('dir-received');
  btnG.className = 'dir-btn given' + (giftDirection==='given'?' active':'');
  btnR.className = 'dir-btn received' + (giftDirection==='received'?' active':'');
  btnG.textContent = l.given;
  btnR.textContent = l.received;
}
function handleOccasionSelect(val) {
  const customInput = document.getElementById('input-occasion');
  if(val === 'Sonstiges') {
    customInput.style.display = 'block';
    customInput.placeholder = 'Anlass eingeben / Enter occasion...';
    customInput.value = '';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = val;
  }
}

function getOccasionValue() {
  const sel = document.getElementById('input-occasion-select');
  const custom = document.getElementById('input-occasion');
  if(sel.value === 'Sonstiges') return custom.value.trim();
  return sel.value;
}

function saveGift() {
  const amount = parseFloat(document.getElementById('input-amount').value);
  const occasion = getOccasionValue();
  const date = document.getElementById('input-gift-date').value;
  const type = document.getElementById('input-type').value;
  const note = document.getElementById('input-gift-note').value.trim();
  if(!amount || !occasion || !date || !currentPersonId) return;
  state.gifts.push({ id: uid(), personId: currentPersonId, direction: giftDirection, amount, occasion, date, type, note });
  save(); closeModal('modal-add-gift');
  showToast(t().toast_saved);
  trackEvent('Geschenk eingetragen', { richtung: giftDirection, betrag: amount });
  openPersonDetail(currentPersonId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatDate(dateStr) {
  if(!dateStr) return '';
  const d = new Date(dateStr);
  return d.toLocaleDateString(state.lang === 'de' ? 'de-DE' : 'en-GB', { day:'2-digit', month:'2-digit', year:'numeric' });
}
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2200);
}
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'giftmemory-backup.json'; a.click();
}
function confirmReset() {
  if(confirm(t().confirmReset)) {
    state.persons = []; state.gifts = []; save();
    showToast(t().toast_deleted); renderPersonList();
  }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OCCASIONS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOccasions() {
  const l = t();
  const search = (document.getElementById('occasion-search')?.value || '').toLowerCase().trim();
  const gradeFilter = document.getElementById('occasion-grade-filter')?.value || '';

  // Populate grade filter dropdown
  const sel = document.getElementById('occasion-grade-filter');
  if(sel) {
    const currentVal = sel.value;
    sel.innerHTML = `<option value="">${l.allGrades}</option>` +
      state.grades.map(g => {
        const label = g.name.split('/')[state.lang==='de'?0:1]?.trim() || g.name;
        return `<option value="${g.id}" ${g.id===currentVal?'selected':''}>${label} (${g.value}â‚¬)</option>`;
      }).join('');
  }

  // Filter gifts
  let filtered = state.gifts.filter(g => g.direction === 'given');
  if(search) filtered = filtered.filter(g => g.occasion.toLowerCase().includes(search));
  if(gradeFilter) {
    const personsInGrade = state.persons.filter(p => p.gradeId === gradeFilter).map(p => p.id);
    filtered = filtered.filter(g => personsInGrade.includes(g.personId));
  }

  const el = document.getElementById('occasions-list');
  if(!filtered.length) {
    el.innerHTML = `<div class="empty-state"><div class="emoji">ğŸ”</div><p>${l.noOccasions}</p></div>`;
    return;
  }

  // Group by occasion name (case-insensitive)
  const groups = {};
  filtered.forEach(g => {
    const key = g.occasion.trim().toLowerCase();
    if(!groups[key]) groups[key] = { label: g.occasion.trim(), items: [] };
    groups[key].items.push(g);
  });

  el.innerHTML = Object.values(groups).sort((a,b) => b.items.length - a.items.length).map(group => {
    const total = group.items.reduce((s,g) => s+g.amount, 0);
    const avg = Math.round(total / group.items.length);
    const rows = group.items.sort((a,b) => new Date(b.date)-new Date(a.date)).map(g => {
      const person = state.persons.find(p => p.id === g.personId);
      const grade = person ? state.grades.find(gr => gr.id === person.gradeId) : null;
      const gradeLabel = grade ? grade.name.split('/')[state.lang==='de'?0:1]?.trim() || grade.name : 'â€“';
      return `<div class="gift-item">
        <div class="gift-dir given" style="font-size:0.8rem;width:32px;height:32px">â†‘</div>
        <div class="gift-info">
          <div class="gift-occasion" style="font-size:0.88rem">${person ? person.name : '?'}</div>
          <div class="gift-date">${gradeLabel} Â· ${formatDate(g.date)}</div>
          ${g.note ? `<div class="gift-note">${g.note}</div>` : ''}
        </div>
        <div class="gift-amount given" style="font-size:0.95rem">${g.amount}â‚¬</div>
      </div>`;
    }).join('');

    return `<div class="card" style="margin-bottom:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:12px;border-bottom:1.5px solid var(--cream2)">
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--brown)">${group.label}</div>
          <div style="font-size:0.75rem;color:var(--gray);margin-top:2px">${group.items.length}Ã— Â· ${l.avgLabel} ${avg}â‚¬ Â· ${l.totalLabel} ${total}â‚¬</div>
        </div>
        <div style="background:var(--gold-pale);color:var(--gold);border-radius:10px;padding:6px 12px;font-family:'Playfair Display',serif;font-weight:700;font-size:1rem">${avg}â‚¬</div>
      </div>
      ${rows}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEEDBACK (Formspree)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendFeedback() {
  const l = t();
  const msg = document.getElementById('feedback-text').value.trim();
  const email = document.getElementById('feedback-email').value.trim();
  const status = document.getElementById('feedback-status');
  const btn = document.getElementById('btn-send-feedback');

  if(!msg) {
    status.style.display = 'block';
    status.style.color = 'var(--red)';
    status.textContent = l.feedbackEmpty;
    return;
  }

  btn.textContent = 'â³ Wird gesendet...';
  btn.disabled = true;
  status.style.display = 'none';

  try {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FORMSPREE SETUP:
    // 1. Geh auf formspree.io â†’ kostenlos registrieren
    // 2. "New Form" erstellen â†’ du bekommst eine Form-ID
    // 3. Ersetze "YOUR_FORM_ID" unten mit deiner ID
    //    Beispiel: https://formspree.io/f/xpzgkwqr
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const FORMSPREE_ID = 'mjgepbok';

    const res = await fetch(`https://formspree.io/f/${FORMSPREE_ID}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({
        message: msg,
        email: email || 'Keine Angabe',
        app_version: 'GiftMemory Web v1',
        lang: state.lang,
        persons_count: state.persons.length,
        gifts_count: state.gifts.length,
      })
    });

    if(res.ok) {
      status.style.display = 'block';
      status.style.color = 'var(--green)';
      status.textContent = l.feedbackOk;
      document.getElementById('feedback-text').value = '';
      document.getElementById('feedback-email').value = '';
      trackEvent('Feedback gesendet');
    } else {
      throw new Error('Server error');
    }
  } catch(e) {
    status.style.display = 'block';
    status.style.color = 'var(--red)';
    status.textContent = l.feedbackErr;
  }

  btn.textContent = l.feedbackSend;
  btn.disabled = false;
}

function renderAll() { renderPersonList(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
applyLang();
renderPersonList();
</script>
</body>
</html>
